<!DOCTYPE html>
<!-- saved from url=(0028)http://192.168.1.9:8443/java -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Code Editor</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/18813/18813467.png" type="image/x-icon">
  <style>
    /* --- Base Styles --- */
    :root {
      font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
      --bg: #0f172a;
      --card: #0b1220;
      --color-muted: #94a3b8;
      --color-active: #ffffff;
      --color-accent: #38bdf8;
      --active-background: #38bdf8;
      --active-color: #04293a;
      --header-item-font-size: 11px;
      --font-size-menu-bar-items: 13px;
      --font-size-tab-items: 14px;
      --icon-foldgutter-folded: "˃";
      --line-muted: rgba(255, 255, 255, 0.2) solid 1px;
      --color-error: #ffcdcd;
      --padding-tooltip: 8px;
      --width-sidebar: 50px;


      --background-alert-error: #9e0000;
      --background-alert: #303030;
      --background-alert-hover: #474747;


    }

    body {
      margin: 0;
      background: var(--card);
      background-color: var(--card);
      color: #ffffff;
      /* padding: 20px; */
      overflow: hidden;
      display: flex;
      overscroll-behavior-y: none;
    }

    .main-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* .wrap {
      max-width: 980px;
      margin: 0 auto
    } */

    /* --- Forms & Buttons --- */
    input,
    select,
    textarea,
    button {
      font: inherit
    }

    button {
      /* background: var(--color-accent); */
      background-color: transparent;
      border: none;
      color: var(--color-accent);
      padding: 8px 12px;
      /* border-radius: 8px; */
      cursor: pointer;
      appearance: none;
      border: none;
      background: none;
      line-height: 1;

    }

    button:hover {
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.1s ease-in-out;
    }

    .btn-ghost {
      font-size: var(--font-size-menu-bar-items);
      background: transparent;
      /* border: 1px solid rgba(255, 255, 255, 0.06); */
      color: var(--color-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }

    .btn-ghost.active {
      text-decoration-line: underline;
      text-decoration-color: var(--color-accent);
      text-underline-offset: 5px;
      text-decoration-thickness: 2px;
      /* color: #04293a; */
      border: none;
      color: white;
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
      /* transition: all 0.1s ease-in-out; */
    }


    /* Red highlight for error state */
    .btn-ghost.error-active {
      /* background: #ef4444; */
      /* Tailwind red-500 */
      color: #ef4444;
      border: none;
      font-weight: 600;
    }

    label {
      font-size: 12px;
      color: var(--color-muted);
      display: block;
      margin-bottom: 6px
    }

    /* --- Layout & Components --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--font-size-menu-bar-items);
      /* margin-bottom: 12px */
    }

    .sidebar,
    .sidebar-window {
      height: 100vh;
      background: var(--card);
      display: flex;
      flex-direction: column;
      align-items: center;
      /* padding-top: 10px; */
      border-right: var(--line-muted);
      width: var(--width-sidebar);
      box-sizing: border-box !important;

    }

    .sidebar-window {
      width: 0px;
      max-width: 50%;
      max-height: 100vh !important;
    }

    .sidebar-window .modal-backdrop {
      background: var(--card);
    }



    .sidebar-btn {
      background: none;
      border: none;
      color: var(--color-muted);
      display: flex;
      flex-direction: column;
      align-items: center !important;
      justify-content: center !important;
      transition: 0.2s;
      cursor: pointer;
      /* max-width: 40px; */
      max-height: 50px !important;
      max-width: inherit;
      position: relative;
      padding: 27px;
      /* max-width: fit-content; */
    }

    .sidebar-btn::after {
      content: attr(icon-title);
      /* use custom attribute instead of title */
      position: absolute;
      left: 60px;
      /* show tooltip to the right of the button */
      top: 50%;
      transform: translateY(-50%);
      background: var(--card);
      color: #fff;
      padding: var(--padding-tooltip);
      border-radius: 8px;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 100;
      border: var(--line-muted);
    }

    .sidebar-btn:hover::after {
      opacity: 1;
    }

    .sidebar-btn:hover {
      color: #fff;
      background: transparent;
      /* background: #2a2a3d; */
    }

    .sidebar-btn>div>i.codicon {
      font-size: 25px;
    }


    .sidebar-icon-img {
      width: 40px;
      height: 30px;
      /* object-fit: contain; */
    }

    .sidebar-label {
      font-size: 10px;
      margin-top: 4px;
    }

    .card {
      background: var(--card);
      z-index: 0;

    }


    .notice {
      color: var(--color-muted);
      font-size: 13px
    }

    .meta {
      display: flex;
      gap: 8px;
      align-items: center
    }

    /* --- Refactored Utility Classes (replacing inline styles) --- */
    .flex {
      display: flex;
      gap: 8px
    }



    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* .gap-6 {
      gap: 6px;
    } */

    .ml-auto {
      margin-left: auto;
    }

    .ml-12 {
      /* margin-left: 12px; */
    }

    .mr-6 {
      /* margin-right: 6px; */
      overflow-y: auto;
      overflow-x: hidden;
    }

    .mb-8 {
      display: none !important;

    }

    .mb-8.active {
      display: block !important;
    }


    /* --- Specific Element Styling (moved from inline) --- */
    #ret,
    #err,
    #vars {
      padding: 8px;
      background: transparent;
      /* border: 1px dashed rgba(255, 255, 255, 0.03); */
      min-width: 0;
      max-width: 100%;
      flex-shrink: 1;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      height: auto;
    }

    #err {
      display: block;
      /* block is safer for multi-line text */
      white-space: pre-wrap;
      /* keep formatting but wrap naturally */
      word-break: break-word;
      overflow-x: auto;
      /* optional: allow scrolling if needed */
    }



    #err {
      color: var(--color-error);
    }

    /* --- Variables List --- */
    .vars-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .var-item {
      padding: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
      /* prevent horizontal overflow */
      min-width: 0;
      max-width: auto;
      flex-shrink: 1;
      overflow-x: hidden;
      word-break: break-word;
    }

    .var-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.1s ease-in-out;
    }

    .var-left {
      /* max-width: 100%; */
      overflow: hidden
    }

    .var-name {
      font-weight: 600
    }

    .preview {
      font-family: ui-monospace, monospace;
      font-size: 12px;
      color: var(--color-muted);
      word-break: break-all
    }

    /* --- Base Modal Styles --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      /* background: rgba(2, 6, 23, 0.5); */
      display: none;
      /* align-items: center; */
      /* justify-content: center; */
      /* padding: 20px; */
      z-index: 60;
      background: transparent;
    }

    .modal {
      left: calc(var(--width-sidebar)*1);
      /* top: calc(var(--width-sidebar)/4); */
      background: var(--card);
      padding: 18px;
      border-radius: 0px !important;
      border-bottom-right-radius: 20px !important;
      /* max-width: 940px; */
      max-height: 86vh;
      width: 80vh;
      overflow-y: auto;
      overflow-x: hidden;
      border: var(--line-muted);
      border-top: none;
      position: fixed;
    }


    .sidebar-modal-backdrop {
      position: absolute;
      inset: 0;
      max-width: 100%;
      /* Child will not exceed parent's width */
      max-height: 100%;
      /* background: rgba(2, 6, 23, 0.5); */
      display: none;
      /* align-items: center; */
      /* justify-content: center; */
      /* padding: 20px; */
      z-index: 60
    }

    .sidebar-modal {
      display: absolute;
      flex-direction: column;
      /* max-width: 100%; */
      width: 100%;
      max-height: 100vh;
      background: var(--card);
      /* border-radius: 8px; */
      /* padding: 16px; */
      overflow: hidden;
      position: absolute;
      display: flex;
    }

    #modalContent {
      white-space: pre-wrap;
      word-break: break-all;
      overflow-x: hidden;
      overflow-y: auto;
      width: 100%;
    }

    #modalTitle {
      word-break: break-all;
      /* allows breaking inside long words (like hashes) */
      overflow-x: hidden;
      /* disable horizontal scroll */
      overflow-y: auto;
    }

    .close-x {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 6px 8px;
      /* border-radius: 8px; */
      color: var(--color-muted);
      cursor: pointer;
    }




    #tasksModal #tasksList button {
      width: 100%;
      text-align: left;
      margin-bottom: 4px;
      background: rgba(255, 255, 255, 0.05);
      border: none;
      padding: 6px 8px;
      border-radius: 4px;
      color: #e6eef8;
      cursor: pointer;
    }


    #browseFileModal ul,
    #browseFileModal #fileList {
      padding: 0;
      margin: 0;
    }

    #fileFilterContainer,
    #tasksFilterContainer {
      overflow: hidden;
    }

    #browseFileModal,
    #tasksModal {
      display: none;
      flex-direction: column;
      height: auto;
      max-height: 100%;
      overflow-x: hidden;
      padding: min(8px, 100%);
      background: var(--card);
      max-width: 100%;
      overflow: hidden;
      position: absolute;
      /* CRITICAL */
    }

    #browseFileModal #fileList,
    #tasksList {
      flex: 1;
      overflow-y: auto;
      /* ONLY THIS SCROLLS */
      min-height: 0;
      padding: 0;

      /* REQUIRED */
    }

    #browseFileModal .file-item,
    #tasksModal .task-item {
      display: flex;
      /* align-items: center;
      text-align: left; */
      /* justify-content: space-between; */
      gap: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      align-items: center;
    }



    #browseFileModal .file-item .file-info {
      display: flex;
      /* align-items: left;
      text-align: left; */
      gap: 8px;
      overflow: hidden;
    }

    #browseFileModal .file-item .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #browseFileModal .file-item .file-meta {
      gap: 12px;
      font-size: 12px;
      color: var(--color-muted);
      /* flex-shrink: 0; */
      display: grid;
      width: 100%;

      grid-auto-flow: column;
      /* place children horizontally */
      grid-auto-columns: 1fr;
      /* each child gets equal width */

      align-items: center;
    }

    #browseFileModal .file-item .file-details {
      width: 100%;
    }

    #browseFileModal .file-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    #browseFileModal .file-item .icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      /* adjust size you want */
      height: 24px;
      /* square for consistency */
      flex-shrink: 0;
    }


    #browseFileModal .file-item .icon .codicon {
      font-size: 20px;
      /* scale icon */
      line-height: 1;
    }

    #browseFileModal .file-item .type-folder {
      color: var(--color-accent);
      /* blue-400 */
    }

    #browseFileModal .file-name {
      display: flex;
      /* blue-400 */
    }

    #browseFileModal .file-item .type-file {
      color: var(--color-muted);
    }

    #browseFileModal #currentPath {
      font-family: ui-monospace, monospace;
      font-size: 12px;
      color: var(--color-muted);
      padding: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      word-break: break-all;
    }

    /* Alerts container (centered) */
    #alertsContainer {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      /* allow clicks to pass through except on children */
      z-index: 9999;
      width: 100%;
      max-width: 100%;
      display: block;
      box-sizing: border-box;
      justify-content: center;
      /* Centers horizontally */
      align-items: center;
    }

    /* Per-alert element (absolute within container) */

    #alertsContainer>.alert {
      position: absolute;
      left: 50%;
      bottom: 20px;
      /* Initial bottom offset; updated by updateAlertPositions via bottom property */
      transform: translateX(-50%);
      background: var(--background-alert);
      color: var(--color-active);
      padding: 8px 14px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity .3s, bottom .3s, transform .3s;
      pointer-events: auto;
      /* allow clicks/hover on alerts */
      max-width: min(90vw, 720px);
      white-space: pre-wrap;
      overflow-wrap: break-word;
      box-sizing: border-box;
      margin: 0;
      display: block;

    }

    #alertsContainer>.alert:hover {
      background-color: var(--background-alert-hover);
      z-index: 1000001;
    }

    #alertsContainer:has(.alert:hover)>.alert:not(:hover) {
      pointer-events: none;
      z-index: 1;
    }

    /* Backwards-compatible id selector (keeps any existing uses working) */

    #alert.error {
      background: var(--background-alert-error);
      color: var(--color-error);
    }

    input {
      outline: none;
      padding: 6px;
      background-color: #0b1220;
      border: 1px solid #333;
      color: #fff;
      border-radius: 4px;
      width: 100%;
      display: flex;
      overflow: hidden;
      /* allow full width */
      box-sizing: border-box;
      /* padding included in width */
      appearance: none;
      position: relative;
      flex-direction: column;
      /* prevent UA overrides */
    }




    input.tab-title-input {
      padding: 0px;
    }




    /* --- CodeMirror Editor Styles --- */
    .CodeMirror {
      background: var(--card);
      color: #e6eef8;
      /* border-radius: 6px; */
      font-size: 13px;
      width: 100%;
      height: 100%;
      position: absolute;
      overscroll-behavior: none !important;
    }



    /* --- Responsive Adjustments --- */
    @media (max-width:720px) {
      .grid-2 {
        grid-template-columns: 1fr
      }

      .meta {
        flex-direction: column;
        align-items: stretch
      }
    }

    /* Custom CSS  */
    /* === VS Code–style match highlighting === */
    .cm-matchhighlight,
    .cm-vscode-highlight {
      background-color: rgba(255, 255, 255, 0.15) !important;
      /* soft white overlay */
    }

    .cm-indent {
      border: #657e8b;
    }

    span.cm-tab,
    .CodeMirror-line>span:not(:has(.cm-tab)):has(> span[cm-text]:only-child) {
      border-left: var(--line-muted);
    }


    .cm-hint-match {
      color: var(--color-accent, #0078d7);
      font-weight: 600;
    }


    /* Red background behind entire error line */
    .cm-error-line,
    .cm-error-gutter {
      background: none !important;
      background-color: rgba(255, 0, 0, 0.15) !important;
    }

    .cm-error-line.CodeMirror-activeline-background,
    .cm-error-gutter.CodeMirror-activeline-gutter {
      background-color: rgba(255, 0, 0, 0.4) !important;
    }


    /* Small red dot in gutter (CodeMirror-lint-markers) */
    .cm-error-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: red !important;
      margin: 0 auto;
      align-items: center;
      justify-content: center;
      display: flex;
      transform: translateY(50%);
    }


    /* clickable error links */
    .err-link {
      display: inline;
      color: #f14c4c;
      cursor: pointer;
      white-space: normal;
      /* position: relative; */
    }

    .err-link:hover {
      color: #ff7070;
      /* text-decoration: underline solid; */
    }

    /* custom tooltip for gutter icons */
    .custom-tooltip {
      position: absolute;
      font-size: 12px;
      pointer-events: none;
      white-space: pre-wrap;
      z-index: 10000;
      background: var(--card);
      color: var(--color-error);
      border: var(--line-muted);
      padding: var(--padding-tooltip);
      display: none;
      transition: opacity 0.15s ease;
      max-width: 50vh;
      border-radius: 8px;
    }



    /* optional: highlight marker on scrollbar */
    .CodeMirror-selection-highlight-scrollbar {
      background-color: rgba(255, 255, 255, 0.677);
    }

    /* make sure it doesn’t clash with selected text */
    .CodeMirror-focused .CodeMirror-selected {
      background-color: rgba(56, 191, 248, 0.176) !important;
      /* your selection color */
    }

    /* === VS Code-style active line highlight === */
    .CodeMirror-activeline-background {
      background: rgba(56, 191, 248, 0.104) !important;

    }

    /* Optional: highlight the gutter line number too */
    .CodeMirror-activeline-gutter .CodeMirror-linenumber {
      /* background: rgba(255, 255, 255, 0.08) !important; */
      color: #fff !important;
      /* or a softer gray like #e6eef8 */
    }


    .CodeMirror-placeholder {
      color: #818181 !important;
    }

    .CodeMirror-search-field {
      /* max-width: 100% !important; */
      width: 80% !important;


    }

    .CodeMirror-search-field {
      /* max-width: 100% !important; */
      width: 80% !important;


    }

    .CodeMirror-gutter-elt {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
    }

    .CodeMirror-linenumber {

      justify-content: right;

      align-items: right;
    }

    .CodeMirror-foldgutter {
      width: 15px !important;
    }

    .CodeMirror-foldgutter-open,
    .CodeMirror-foldgutter-folded {
      font-size: 20px;
      line-height: 0.8em;
      /* color: yellowgreen; */
    }

    .CodeMirror-lines {
      padding-left: 100px;
    }

    /* --- Tab Styles --- */
    .tab-container {
      display: flex;
      align-items: center;
      background: var(--card);
    }

    .tabs {
      display: flex;
      gap: 2px;
      overflow-x: auto;
      flex-grow: auto;
      padding-bottom: 4px;
      /* For scrollbar spacing */
    }

    /* Hide scrollbar for webkit browsers */
    .tabs::-webkit-scrollbar,
    body::-webkit-scrollbar {
      display: none;
    }

    #browseFileModal::-webkit-scrollbar,
    #browseFileModal #fileList::-webkit-scrollbar,
    .modal::-webkit-scrollbar,
    #tasksList::-webkit-scrollbar,
    #modalContent::-webkit-scrollbar {
      width: 5px;
      height: 8px;
      background-color: transparent;
    }

    #browseFileModal::-webkit-scrollbar-thumb,
    #fileList::-webkit-scrollbar-thumb,
    #tasksList::-webkit-scrollbar-thumb {
      border-radius: 10px;
      background-color: var(--color-muted);
    }


    .tab-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: transparent;
      max-width: 200px;
      white-space: nowrap;
      color: var(--color-muted);
      font-size: var(--font-size-tab-items);
    }

    .tab-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .tab-item.active {
      border-bottom: 2px solid var(--active-background);
      color: white;
    }

    .tab-title-input {
      outline: none;
      border: transparent;
      color: inherit;
      background: transparent;
      max-height: inherit;
      /* border-radius: 4px; */
    }


    .tab-close {
      font-size: 14px;
      /* padding: px; */
      border-radius: 4px;
      line-height: 1;
    }

    .tab-close:hover {
      color: red;
      cursor: pointer;
      font-weight: 600;
    }

    #add-tab-btn {
      background: transparent;
      padding: 8px 12px;
      border-radius: 6px;
      flex-shrink: 0;
      /* Prevent shrinking */
      margin-left: 4px;
    }

    #add-tab-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .code-editor {
      display: flex;
      flex-direction: column;
      height: 100vh;
      /* or fit to your layout */
    }

    .code-editor,
    #editors-container,
    .editor-wrapper {
      overflow-x: hidden !important;
      /* position: relative; */

    }

    .editor-wrapper {
      height: inherit;
      position: absolute;
      width: 100%;
      /* display: block; */
      /* max-height: 70vh; */
    }

    .editor-wrapper>div {
      height: 100%;
    }

    /* Hide horizontal scrollbar only (cross-browser) */
    .code-editor::-webkit-scrollbar:horizontal,
    #editors-container::-webkit-scrollbar:horizontal,
    .editor-wrapper::-webkit-scrollbar:horizontal {
      display: none;
    }

    .code-editor,
    #editors-container,
    .editor-wrapper {
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;
    }

    #debugger-panel-container {
      display: grid;
      width: 100%;

      grid-auto-flow: column;
      /* place children horizontally */
      grid-auto-columns: 1fr;
      /* each child gets equal width */

      align-items: center;
    }

    #debugger-panel-container>* {
      min-width: 0;
      /* prevents content from expanding grid */
    }

    #runBtn {
      color: var(--color-accent);
    }


    #status-panel {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 2px 8px;
      font-size: 12px;
      color: var(--color-muted);
      background: transparent;
      border-radius: 4px;
      user-select: none;
      white-space: nowrap;
    }

    /* individual items */
    #status-panel span {
      justify-content: center;
      padding: 2px 4px;
      border-radius: 3px;
    }

    #run-status-panel {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    #run-status-panel>span {
      text-align: right;
      padding-right: 8px;
    }



    main {

      display: flex;
      flex-direction: column;
    }

    #editors-container {
      overflow: hidden !important;
      overscroll-behavior: none;
      width: 100% !important;
    }

    #debugger-container {
      border-top: var(--line-muted);
      height: 24px;
    }

    .CodeMirror-hscrollbar {
      height: 0 !important;
      overflow: hidden !important;
    }

    /* The editors container stays in normal flow */
    #editors-container {
      width: 100%;
      height: 70vh;
      /* fixed height area for editors */
      z-index: 1;
      /* background: #111; */
      /* optional background for clarity */
      overflow-x: hidden;
      overflow-y: scroll;
    }

    /* Stack editors inside this area */
    .editor-wrapper {
      /* overlap editors inside container */
      top: 0;
      left: 0;
      width: inherit;
      height: inherit;
      /* visibility: hidden; */
      /* display: none; */
      pointer-events: none;
      z-index: 0;
      overflow-x: hidden;
    }

    /* Active one visible */
    .editor-wrapper.active {
      /* visibility: visible; */
      /* display: block; */
      pointer-events: auto;
      z-index: 2;
    }



    /* Card appears below editors normally */
    .card {

      z-index: 0;
    }

    .variable-count-active {
      background: transparent;
    }

    .cm-property {
      color: #90e5dc;
    }

    .cm-variable-2 {
      color: #ff944d;
    }

    /* === Container === */
    ul.CodeMirror-hints {
      list-style: none;
      padding: 4px 0;
      border: 1px solid #333;
      background: var(--card);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      color: #d4d4d4;
      font-family: Consolas, "Courier New", monospace;
      font-size: 13px;
      max-width: 70vh;
      max-height: 30vh;
    }

    /* === List items === */
    li.CodeMirror-hint {
      flex-direction: column;
      padding: 3px;
    }

    /* === Active / Hover state === */
    li.CodeMirror-hint-active,
    li.CodeMirror-hint:hover {
      background: rgba(255, 255, 255, 0.05);

      background-color: #094771 !important;
      /* border-left-width: 2px; */
      font-weight: bold;
      padding: 2px;
      transition: all 0.1s ease-in-out;
    }

    /* === Title (main text) === */
    .CodeMirror-hints-title {
      color: #dcdcdc;
      font-size: 1em;
    }

    /* === Subtext (detail line) === */
    .CodeMirror-hints-subtext {
      display: inline-flex;
      color: #808080;
      font-size: 0.8em;
      height: auto;
      white-space: normal;
      word-break: break-word;
    }


    /* === Scrollbar (VS Code style) === */
    .CodeMirror-hints::-webkit-scrollbar {
      width: 8px;
    }

    .CodeMirror-hints::-webkit-scrollbar-thumb {
      background: #3c3c3c;
      border-radius: 4px;
    }

    .CodeMirror-hints::-webkit-scrollbar-thumb:hover {
      background: #555;
    }




    .circle {
      display: none;
      background-color: var(--color-accent);
      color: #04293a;
      border-radius: 40px;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 4px;
    }

    /* Breadcrumb path segments shown in file browser header */
    .path-segment {
      cursor: pointer;
      color: var(--color-accent);
      text-decoration: none;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      user-select: none;
      display: inline-block;
    }
    .path-segment:focus,
    .path-segment:hover {
      background: rgba(255,255,255,0.04);
      outline: none;
      color: var(--color-active);
    }
    .path-sep {
      color: var(--color-muted);
      margin: 0 6px;
      user-select: none;
    }

  </style>
  <script>

    // ✅ One array for all resources — order preserved
    const cdnResources = [
      'https://cdn.jsdelivr.net/npm/@vscode/codicons@0.0.42/dist/codicon.min.css',
      'https://cdn.jsdelivr.net/npm/@vscode/codicons@0.0.42/scripts/export-to-ts.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/codemirror.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/fold/foldgutter.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/hint/show-hint.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/theme/blackboard.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/scroll/simplescrollbars.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/dialog/dialog.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/display/fullscreen.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/lint/lint.min.css',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/codemirror.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/mode/clike/clike.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/fold/foldcode.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/fold/comment-fold.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/fold/foldgutter.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/fold/brace-fold.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/hint/show-hint.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/mode/simple.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/scroll/simplescrollbars.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/edit/closebrackets.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/edit/matchbrackets.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/display/placeholder.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/display/autorefresh.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/display/rulers.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/search/searchcursor.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/search/search.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/dialog/dialog.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/selection/active-line.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/search/match-highlighter.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/display/fullscreen.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/display/panel.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/search/jump-to-line.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/comment/comment.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.4/beautify.js',
      'https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.4/beautify.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/addon/lint/lint.min.js'

    ];

    async function loadCdnResources(urls) {
      const loaded = new Set();

      for (const url of urls) {
        if (!url || loaded.has(url)) continue;

        // Auto-detect file type
        const isCSS = url.trim().toLowerCase().endsWith('.css');
        const isJS = url.trim().toLowerCase().endsWith('.js');

        if (isCSS) {
          // Skip if already added
          if (document.querySelector(`link[href="${url}"]`)) continue;
          await new Promise((resolve, reject) => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;
            link.onload = resolve;
            link.onerror = () => reject(new Error(`Failed to load CSS: ${url}`));
            document.head.appendChild(link);
          });
        } else if (isJS) {
          if (document.querySelector(`script[src="${url}"]`)) continue;
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.async = false; // preserve load order
            script.defer = false;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`Failed to load JS: ${url}`));
            document.head.appendChild(script);
          });
        } else {
          console.warn(`⚠️ Unknown file type (skipped): ${url}`);
        }

        loaded.add(url);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Load all and emit global event
      loadCdnResources(cdnResources)
        .then(() => {
          console.log("✅ All CDN resources loaded.");
          window.dispatchEvent(new Event("cdnLoaded"));
        })
        .catch(err => console.error("❌ Failed to load CDN resources:", err));
    });
  </script>


<link rel="stylesheet" href="./Code Editor_files/codicon.min.css"><script src="./Code Editor_files/export-to-ts.min.js.download"></script><link rel="stylesheet" href="./Code Editor_files/codemirror.min.css"><link rel="stylesheet" href="./Code Editor_files/foldgutter.min.css"><link rel="stylesheet" href="./Code Editor_files/show-hint.min.css"><link rel="stylesheet" href="./Code Editor_files/blackboard.min.css"><link rel="stylesheet" href="./Code Editor_files/simplescrollbars.min.css"><link rel="stylesheet" href="./Code Editor_files/dialog.min.css"><link rel="stylesheet" href="./Code Editor_files/fullscreen.min.css"><link rel="stylesheet" href="./Code Editor_files/lint.min.css"><script src="./Code Editor_files/codemirror.min.js.download"></script><script src="./Code Editor_files/clike.min.js.download"></script><script src="./Code Editor_files/foldcode.min.js.download"></script><script src="./Code Editor_files/comment-fold.min.js.download"></script><script src="./Code Editor_files/foldgutter.min.js.download"></script><script src="./Code Editor_files/brace-fold.min.js.download"></script><script src="./Code Editor_files/show-hint.min.js.download"></script><script src="./Code Editor_files/simple.min.js.download"></script><script src="./Code Editor_files/simplescrollbars.min.js.download"></script><script src="./Code Editor_files/closebrackets.js.download"></script><script src="./Code Editor_files/matchbrackets.js.download"></script><script src="./Code Editor_files/placeholder.min.js.download"></script><script src="./Code Editor_files/autorefresh.min.js.download"></script><script src="./Code Editor_files/rulers.min.js.download"></script><script src="./Code Editor_files/searchcursor.min.js.download"></script><script src="./Code Editor_files/search.min.js.download"></script><script src="./Code Editor_files/dialog.min.js.download"></script><script src="./Code Editor_files/active-line.min.js.download"></script><script src="./Code Editor_files/match-highlighter.min.js.download"></script><script src="./Code Editor_files/fullscreen.min.js.download"></script><script src="./Code Editor_files/panel.min.js.download"></script><script src="./Code Editor_files/jump-to-line.min.js.download"></script><script src="./Code Editor_files/comment.min.js.download"></script><script src="./Code Editor_files/beautify.js.download"></script><script src="./Code Editor_files/beautify.min.js.download"></script><script src="./Code Editor_files/lint.min.js.download"></script></head>

<body style=""><div class="sidebar" style="position: relative;"><button class="sidebar-btn" icon-title="Session"><div class="icon-container"><i class="codicon codicon-project"></i></div></button><button class="sidebar-btn" icon-title="Open File"><div class="icon-container"><i class="codicon codicon-files"></i></div></button><button class="sidebar-btn" icon-title="Save All"><div class="icon-container"><i class="codicon codicon-save-all"></i></div></button><button class="sidebar-btn" icon-title="Select Task Before Run"><div class="icon-container"><i class="codicon codicon-sort-precedence"></i></div></button><button class="sidebar-btn" icon-title="Import Code"><div class="icon-container"><i class="codicon codicon-cloud-download"></i></div></button><button class="sidebar-btn" icon-title="Sync Repository"><div class="icon-container"><i class="codicon codicon-github"></i></div></button><button class="sidebar-btn" icon-title="Create/Update Gist"><div class="icon-container"><i class="codicon codicon-gist-secret"></i></div></button></div>
  
  <div id="sidebar-window" class="sidebar-window" style="position: relative; width: 45vh;">
    <div id="browseFileModal" class="sidebar-modal-backdrop" style="display: flex;">
      <!-- <div class="sidebar-modal"> -->
      <!-- <div class="flex-between mb-8" style="display: none;">
          <button id="closeBrowseFileModal" class="close-x">Close</button>
        </div> -->
      <div id="fileFilterContainer">
        <input type="text" id="fileFilterInput" placeholder="Filter files...">
        <div class="flex-between">
          <!-- <div> -->
          <input type="text" id="newFolderName" placeholder="New folder name..." style="background: #0b1220; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 6px; color: #fff;">
          <button id="mkdirBtn" class="btn-ghost">Create Folder</button>
          <!-- </div> -->
          <button id="saveFileFab" class="btn-ghost" style="display: none;">Save Here</button>
        </div>
        <div id="currentPath"><span class="path-segment" title="/storage" tabindex="0">storage</span><span class="path-sep"> &gt; </span><span class="path-segment" title="/storage/emulated" tabindex="0">emulated</span><span class="path-sep"> &gt; </span><span class="path-segment" title="/storage/emulated/0" tabindex="0">0</span><span class="path-sep"> &gt; </span><span class="path-segment" title="/storage/emulated/0/Tasker" tabindex="0">Tasker</span><span class="path-sep"> &gt; </span><span class="path-segment" title="/storage/emulated/0/Tasker/Files" tabindex="0">Files</span><span class="path-sep"> &gt; </span><span class="path-segment" title="/storage/emulated/0/Tasker/Files/Beanshell" tabindex="0">Beanshell</span></div>
      </div>

      <ul id="fileList"><div class="file-item" id="parent-dir"><span class="icon">..</span> <span class="name">Parent Directory</span></div><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">AccessibilityAction</span>
    <div class="file-meta">
      <span>3 hours ago at 17.19</span>      
      <span>4 files</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">CodeEditor</span>
    <div class="file-meta">
      <span>2 hours ago at 17.57</span>      
      <span>4 files</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">commands</span>
    <div class="file-meta">
      <span>Oct 17, 25, 06:29 PM</span>      
      <span>2 files</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">jaxb-ri</span>
    <div class="file-meta">
      <span>Oct 17, 25, 08:51 AM</span>      
      <span>5 files</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">jaxb-ri-3.0.0</span>
    <div class="file-meta">
      <span>Oct 17, 25, 08:51 AM</span>      
      
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">lib</span>
    <div class="file-meta">
      <span>Nov 13, 25, 03:29 PM</span>      
      <span>6 files</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-folder">
    <span class="codicon codicon-folder"></span>
  </span>
  <div class="file-details">
    <span class="name">Test</span>
    <div class="file-meta">
      <span>1 second ago</span>      
      <span>33 files</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-file">
    <span class="codicon codicon-file"></span>
  </span>
  <div class="file-details">
    <span class="name">Accessibility.bsh</span>
    <div class="file-meta">
      <span>3 hours ago at 17.41</span>      
      <span>50.2 KB</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-file">
    <span class="codicon codicon-file"></span>
  </span>
  <div class="file-details">
    <span class="name">CodeMirror.html</span>
    <div class="file-meta">
      <span>Oct 19, 25, 01:11 PM</span>      
      <span>70 KB</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-file">
    <span class="codicon codicon-file"></span>
  </span>
  <div class="file-details">
    <span class="name">jaxb-ri-3.0.0.zip</span>
    <div class="file-meta">
      <span>Oct 17, 25, 06:55 AM</span>      
      <span>3.7 MB</span>
    </div>
  </div>
</li><li class="file-item">
  <span class="icon type-file">
    <span class="codicon codicon-file"></span>
  </span>
  <div class="file-details">
    <span class="name">takePhoto.bsh</span>
    <div class="file-meta">
      <span>Oct 23, 25, 07:58 AM</span>      
      <span>2.2 KB</span>
    </div>
  </div>
</li></ul>

      <!-- </div> -->
    </div>
    <div id="tasksModal" class="sidebar-modal-backdrop" style="display: none;">
      <div id="tasksFilterContainer">
        <input type="text" id="taskFilter" placeholder="Filter tasks...">
      </div>
      <ul id="tasksList"></ul>

      <!-- <div style="text-align:right;"> <button id="closeTasks" class="btn-ghost">Close</button> -->
    </div>
  <div class="resize-handle-right" id="resize-handle-right" style="position: absolute; user-select: none; z-index: 9999; background: transparent; right: -4px; top: 0px; width: 6px; height: 100%; cursor: ew-resize;"></div></div>
  
  
  <div class="main-body">

    <div class="code-editor">
      <main>

        <div class="tab-container">
          <div class="tabs" id="tabs-list">
            <!-- Tabs will be dynamically added here -->
          <div class="tab-item" data-tab-id="1" draggable="true"><span>text.txt</span><span class="tab-close">✕</span></div><div class="tab-item active" data-tab-id="2" draggable="true"><span>AccessibilityEvent.bsh</span><span class="tab-close">✕</span></div><div class="tab-item" data-tab-id="3" draggable="true"><span>AccEventStop.bsh</span><span class="tab-close">✕</span></div><div class="tab-item" data-tab-id="5" draggable="true"><span>Untitled-5</span><span class="tab-close">✕</span></div><div class="tab-item" data-tab-id="6" draggable="true"><span>Accessibility.bsh</span><span class="tab-close">✕</span></div></div>
          <button id="add-tab-btn" class="btn-ghost" title="New Tab">+</button>
        </div>
        <div id="editors-container" style="position: relative;">
          <!-- Editor instances will be added here -->
        <div class="resize-handle-bottom" id="resize-handle-bottom" style="position: absolute; user-select: none; z-index: 9999; background: transparent; bottom: -6px; left: 0px; height: 12px; width: 100%; cursor: ns-resize;"></div><div class="editor-wrapper"><textarea style="display: none;"></textarea><div class="CodeMirror cm-s-blackboard CodeMirror-wrap CodeMirror-overlayscroll" translate="no"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 239.446px; left: 65.8949px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; min-height: 1em; outline: none;"></textarea></div><div class="CodeMirror-overlayscroll-horizontal" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-overlayscroll-vertical" cm-not-content="true" style="display: block; bottom: 0px;"><div style="height: 167.869px; top: 173.708px;"></div></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1" draggable="false"><div class="CodeMirror-sizer" style="margin-left: 61px; margin-bottom: -16px; border-right-width: 34px; min-height: 2141px; padding-right: 5px; padding-bottom: 0px;"><div style="position: relative; top: 479.091px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre class="CodeMirror-line-like">x</pre></div><div class="CodeMirror-measure"><pre class="CodeMirror-line" role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-cursors" style="visibility: hidden;"><div class="CodeMirror-cursor" style="left: 4.90057px; top: 401.818px; height: 15.4545px;">&nbsp;</div></div><div class="CodeMirror-code" role="presentation" style=""><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">32</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Detect if target is BSSID (MAC address) */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">isMac</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">macPattern</span> <span class="cm-operator">=</span> <span class="cm-string">"^[0-9A-Fa-f]{2}(:[0-9A-Fa-f]{2}){5}$"</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">35</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">target</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">target</span>.<span class="cm-def">matches</span>(<span class="cm-variable">macPattern</span><span class="cm-bracket">))</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">36</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">isMac</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">37</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">38</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">39</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/*──────────────────────</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">40</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> &nbsp; &nbsp; * 1) TRY SHIZUKU METHOD</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">41</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> &nbsp; &nbsp; *──────────────────────*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">42</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">shizukuOk</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">43</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">44</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">45</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wifi</span> <span class="cm-operator">=</span> <span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">getShizukuService</span><span class="cm-bracket">(</span>Context<span class="cm-punctuation">.</span>WIFI_SERVICE<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">46</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">47</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">wifi</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">48</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wifiManager</span> <span class="cm-operator">=</span> (<span class="cm-variable">WifiManager</span><span class="cm-bracket">)</span> wifi<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">49</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">50</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">config</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-def">WifiConfiguration</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">51</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">52</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">isMac</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">53</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  config<span class="cm-punctuation">.</span><span class="cm-variable">BSSID</span> <span class="cm-operator">=</span> target<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">54</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  config<span class="cm-punctuation">.</span><span class="cm-variable">SSID</span> <span class="cm-operator">=</span> <span class="cm-string">"\"\""</span><span class="cm-punctuation">;</span> <span class="cm-comment">/* Required dummy SSID */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">55</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span> <span class="cm-keyword">else</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">56</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  config<span class="cm-punctuation">.</span><span class="cm-variable">SSID</span> <span class="cm-operator">=</span> <span class="cm-string">"\""</span> <span class="cm-operator">+</span> target <span class="cm-operator">+</span> <span class="cm-string">"\""</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">57</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;" class="CodeMirror-activeline"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -61px; width: 61px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">58</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">59</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">password</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">password</span>.<span class="cm-def">trim</span><span class="cm-bracket">()</span><span class="cm-punctuation">.</span><span class="cm-def">length</span><span class="cm-bracket">()</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">60</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  config<span class="cm-punctuation">.</span><span class="cm-variable">preSharedKey</span> <span class="cm-operator">=</span> <span class="cm-string">"\""</span> <span class="cm-operator">+</span> password <span class="cm-operator">+</span> <span class="cm-string">"\""</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">61</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span> <span class="cm-keyword">else</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">62</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  config<span class="cm-punctuation">.</span><span class="cm-variable">allowedKeyManagement</span>.<span class="cm-def">set</span><span class="cm-bracket">(</span>WifiConfiguration<span class="cm-punctuation">.</span>KeyMgmt<span class="cm-punctuation">.</span>NONE<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">63</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">64</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">65</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">netId</span> <span class="cm-operator">=</span> <span class="cm-variable">wifiManager</span>.<span class="cm-def">addNetwork</span>(<span class="cm-variable">config</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">66</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">67</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">netId</span> <span class="cm-operator">!=</span> <span class="cm-operator">-</span><span class="cm-number">1</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div class="" style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">68</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wifiManager</span>.<span class="cm-def">disconnect</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">69</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wifiManager</span>.<span class="cm-def">enableNetwork</span>(<span class="cm-variable">netId</span>, <span class="cm-variable">true</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">70</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wifiManager</span>.<span class="cm-def">reconnect</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">71</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">72</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">log</span><span class="cm-bracket">(</span><span class="cm-string">"Shizuku: Connected via WifiManager."</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">73</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">shizukuOk</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">74</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span> <span class="cm-keyword">else</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">75</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">log</span><span class="cm-bracket">(</span><span class="cm-string">"Shizuku: addNetwork returned -1."</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">76</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">77</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span> <span class="cm-keyword">else</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">78</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">log</span><span class="cm-bracket">(</span><span class="cm-string">"Shizuku: Wifi service not found."</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">79</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">80</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">81</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">}</span> <span class="cm-keyword">catch</span> (<span class="cm-property">Exception</span> <span class="cm-variable-2">e</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">82</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">log</span><span class="cm-bracket">(</span><span class="cm-string">"Shizuku error → falling back."</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">83</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">84</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">85</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">shizukuOk</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">86</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"shizuku"</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">87</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">88</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -61px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 22px;">89</div><div class="CodeMirror-gutter-elt" style="left: 46px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/*──────────────────────────────</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 34px; width: 1px; border-bottom: 0px solid transparent; top: 2141px;"></div><div class="CodeMirror-gutters" style="height: 2175px;"><div class="CodeMirror-gutter CodeMirror-lint-markers"></div><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 30px;"></div><div class="CodeMirror-gutter CodeMirror-foldgutter"></div></div></div></div></div><div class="editor-wrapper active"><textarea style="display: none;"></textarea><div class="CodeMirror cm-s-blackboard CodeMirror-wrap CodeMirror-overlayscroll CodeMirror-focused" translate="no"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 577px; left: 99.7585px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; min-height: 1em; outline: none;" aria-autocomplete="list"></textarea></div><div class="CodeMirror-overlayscroll-horizontal" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-overlayscroll-vertical" cm-not-content="true" style="display: block; bottom: 0px;"><div style="height: 292.794px; top: 0px;"></div></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1" draggable="false"><div class="CodeMirror-sizer" style="margin-left: 60px; margin-bottom: -16px; border-right-width: 34px; min-height: 1213px; padding-right: 5px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre class="CodeMirror-line-like"><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>78</div></div></div><div class="CodeMirror-measure"><pre class="CodeMirror-line" role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket CodeMirror-matchingbracket">}</span></span></pre></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-cursors" style="visibility: hidden;"></div><div class="CodeMirror-code" role="presentation" style=""><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> android<span class="cm-punctuation">.</span>view<span class="cm-punctuation">.</span>accessibility<span class="cm-punctuation">.</span>AccessibilityEvent<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> android<span class="cm-punctuation">.</span>view<span class="cm-punctuation">.</span>accessibility<span class="cm-punctuation">.</span>AccessibilityNodeInfo<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> java<span class="cm-punctuation">.</span>util<span class="cm-punctuation">.</span>HashMap<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">5</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/*───────────────────────────────────────────────────────────────</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * buildEventJson(e)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Builds a JSON log entry for ANY accessibility event</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *──────────────────────────────────────────────────────────────*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">9</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">buildEventJson</span>(<span class="cm-variable">e</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-def">HashMap</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">12</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Basic event metadata */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"eventType"</span><span class="cm-punctuation">,</span> <span class="cm-variable">e</span>.<span class="cm-def">getEventType</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"eventTypeName"</span><span class="cm-punctuation">,</span> <span class="cm-variable">AccessibilityEvent</span>.<span class="cm-def">eventTypeToString</span><span class="cm-bracket">(</span><span class="cm-variable">e</span>.<span class="cm-def">getEventType</span><span class="cm-bracket">()))</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"packageName"</span><span class="cm-punctuation">,</span> <span class="cm-variable">e</span>.<span class="cm-def">getPackageName</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"className"</span><span class="cm-punctuation">,</span> <span class="cm-variable">e</span>.<span class="cm-def">getClassName</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"eventTime"</span><span class="cm-punctuation">,</span> <span class="cm-variable">e</span>.<span class="cm-def">getEventTime</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">19</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Text content */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">txt</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>.<span class="cm-def">getText</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"text"</span><span class="cm-punctuation">,</span> <span class="cm-variable">txt</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">?</span> <span class="cm-variable">txt</span>.<span class="cm-def">toString</span><span class="cm-bracket">()</span> <span class="cm-operator">:</span> <span class="cm-string">""</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"contentDescription"</span><span class="cm-punctuation">,</span> <span class="cm-variable">e</span>.<span class="cm-def">getContentDescription</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">24</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Source node details */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">node</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>.<span class="cm-def">getSource</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">26</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">node</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"viewId"</span><span class="cm-punctuation">,</span> <span class="cm-variable">node</span>.<span class="cm-def">getViewIdResourceName</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"sourceClassName"</span><span class="cm-punctuation">,</span> <span class="cm-variable">node</span>.<span class="cm-def">getClassName</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"sourcePackageName"</span><span class="cm-punctuation">,</span> <span class="cm-variable">node</span>.<span class="cm-def">getPackageName</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"clickable"</span><span class="cm-punctuation">,</span> <span class="cm-variable">node</span>.<span class="cm-def">isClickable</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"enabled"</span><span class="cm-punctuation">,</span> <span class="cm-variable">node</span>.<span class="cm-def">isEnabled</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"checked"</span><span class="cm-punctuation">,</span> <span class="cm-variable">node</span>.<span class="cm-def">isChecked</span><span class="cm-bracket">())</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">33</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">}</span> <span class="cm-keyword">else</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"viewId"</span><span class="cm-punctuation">,</span> <span class="cm-string">""</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">35</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"sourceClassName"</span><span class="cm-punctuation">,</span> <span class="cm-string">""</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">36</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"sourcePackageName"</span><span class="cm-punctuation">,</span> <span class="cm-string">""</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">37</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"clickable"</span>, <span class="cm-variable">false</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">38</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"enabled"</span>, <span class="cm-variable">false</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">39</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-def">put</span><span class="cm-bracket">(</span><span class="cm-string">"checked"</span>, <span class="cm-variable">false</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">40</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">41</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">42</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">toJson</span>(<span class="cm-variable">map</span>, <span class="cm-variable">true</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">43</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">44</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">45</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/*───────────────────────────────────────────────────────────────</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">46</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * MAIN LOOP — reacts to ALL accessibility events</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">47</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *──────────────────────────────────────────────────────────────*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">48</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">49</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> (<span class="cm-variable">true</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">50</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* Stop control */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">51</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">stop</span> <span class="cm-operator">=</span> <span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-builtin">getVariable</span><span class="cm-bracket">(</span><span class="cm-string">"StopLog"</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">52</div><div class="CodeMirror-gutter-elt" style="left: 45px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">stop</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">stop</span>.<span class="cm-def">equals</span><span class="cm-bracket">(</span><span class="cm-string">"1"</span><span class="cm-bracket">))</span> <span class="cm-bracket CodeMirror-matchingbracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 15px;">53</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"Stopped"</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 34px; width: 1px; border-bottom: 0px solid transparent; top: 1213px;"></div><div class="CodeMirror-gutters" style="height: 1247px;"><div class="CodeMirror-gutter CodeMirror-lint-markers"></div><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div><div class="CodeMirror-gutter CodeMirror-foldgutter"></div></div></div></div></div><div class="editor-wrapper"><textarea style="display: none;"></textarea><div class="CodeMirror cm-s-blackboard CodeMirror-wrap CodeMirror-overlayscroll" translate="no"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 50.3551px; left: 93.4943px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; min-height: 1em; outline: none;" aria-autocomplete="list"></textarea></div><div class="CodeMirror-overlayscroll-horizontal" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-overlayscroll-vertical" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1" draggable="false"><div class="CodeMirror-sizer" style="margin-left: 60px; margin-bottom: -16px; border-right-width: 34px; min-height: 70px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre class="CodeMirror-line-like"><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-cursors" style="visibility: hidden;"><div class="CodeMirror-cursor" style="left: 33.4943px; top: 46.3636px; height: 15.4545px;">&nbsp;</div></div><div class="CodeMirror-code" role="presentation" style=""><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-builtin">setVariable</span><span class="cm-bracket">(</span><span class="cm-string">"Count"</span><span class="cm-punctuation">,</span> <span class="cm-string">"0"</span> <span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-builtin">setVariable</span><span class="cm-bracket">(</span><span class="cm-string">"StopLog"</span><span class="cm-punctuation">,</span> <span class="cm-string">"1"</span> <span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -60px; width: 60px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 34px; width: 1px; border-bottom: 0px solid transparent; top: 70px;"></div><div class="CodeMirror-gutters" style="height: 104px;"><div class="CodeMirror-gutter CodeMirror-lint-markers"></div><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div><div class="CodeMirror-gutter CodeMirror-foldgutter"></div></div></div></div></div><div class="editor-wrapper"><textarea style="display: none;"></textarea><div class="CodeMirror cm-s-blackboard CodeMirror-wrap CodeMirror-overlayscroll" translate="no"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 50.3551px; left: 186.449px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; min-height: 1em; outline: none;" aria-autocomplete="list"></textarea></div><div class="CodeMirror-overlayscroll-horizontal" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-overlayscroll-vertical" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 60px; margin-bottom: -16px; border-right-width: 34px; min-height: 70px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre class="CodeMirror-line-like">x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-cursors" style=""><div class="CodeMirror-cursor" style="left: 126.449px; top: 46.3636px; height: 15.4545px;">&nbsp;</div></div><div class="CodeMirror-code" role="presentation"><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">index</span> <span class="cm-operator">=</span> <span class="cm-variable">Integer</span>.<span class="cm-def">parseInt</span><span class="cm-bracket">(</span><span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-builtin">getVariable</span><span class="cm-bracket">(</span><span class="cm-string">"Count"</span><span class="cm-bracket">))</span> <span class="cm-operator">+</span> <span class="cm-number">1</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-builtin">setVariable</span><span class="cm-bracket">(</span><span class="cm-string">"Count"</span>, <span class="cm-variable">index</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -60px; width: 60px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" aria-hidden="true" style="left: -60px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 8px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> index<span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 34px; width: 1px; border-bottom: 0px solid transparent; top: 70px;"></div><div class="CodeMirror-gutters" style="height: 104px;"><div class="CodeMirror-gutter CodeMirror-lint-markers"></div><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div><div class="CodeMirror-gutter CodeMirror-foldgutter"></div></div></div></div></div><div class="editor-wrapper"><textarea style="display: none;"></textarea><div class="CodeMirror cm-s-blackboard CodeMirror-wrap CodeMirror-overlayscroll" translate="no"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 165.923px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; min-height: 1em; outline: none;"></textarea></div><div class="CodeMirror-overlayscroll-horizontal" cm-not-content="true" style="display: none;"><div></div></div><div class="CodeMirror-overlayscroll-vertical" cm-not-content="true" style="display: block; bottom: 0px;"><div style="height: 15.9934px; top: 59.4436px;"></div></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 69px; margin-bottom: -16px; border-right-width: 34px; min-height: 22795px; padding-right: 5px; padding-bottom: 0px;"><div style="position: relative; top: 1870.27px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre class="CodeMirror-line-like">x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"><div class="CodeMirror-selected" style="position: absolute; left: 25.4546px; top: 355px; width: 71.4772px; height: 16px;"></div></div><div class="CodeMirror-cursors" style=""></div><div class="CodeMirror-code" role="presentation" style=""><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">122</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">123</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">124</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/*───────────────────────────────────────────────────────────────</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">125</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * rootChanged(AccessibilityNodeInfo oldRoot, String oldSig)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">126</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * **Check for UI Change**</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">127</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Checks if the current UI has changed by comparing old and new screen signatures.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">128</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">129</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Arguments:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">130</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * * - oldRoot → Snapshot before the action.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">131</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * * - oldSig → Signature of the oldRoot.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">132</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">133</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Example:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">134</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * if (rootChanged(oldRoot, oldSig)) { ... }</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">135</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * ───────────────────────────────────────────────────────────────*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">136</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">boolean</span> <span class="cm-def">rootChanged</span>(<span class="cm-property">AccessibilityNodeInfo</span> <span class="cm-variable-2">oldRoot</span>, <span class="cm-property">String</span> <span class="cm-variable-2">oldSig</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">137</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">newRoot</span> <span class="cm-operator">=</span> <span class="cm-def">getRoot</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">138</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">newRoot</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span><span class="cm-bracket">)</span> <span class="cm-keyword">return</span> <span class="cm-atom">true</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">139</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">newSig</span> <span class="cm-operator">=</span> <span class="cm-def">rootSignature</span>(<span class="cm-variable">newRoot</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">140</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-operator">!</span><span class="cm-variable">newSig</span>.<span class="cm-def">equals</span>(<span class="cm-variable">oldSig</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">141</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">142</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">143</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">144</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/*───────────────────────────────────────────────────────────────</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">145</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * </span><span class="cm-comment cm-overlay cm-searching cm-overlay cm-vscode-highlight">waitNodes(</span><span class="cm-comment">key, value, timeoutMs)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">146</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Waits for next AccessibilityEvents until a node matching the</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">147</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * selector is found. Returns the first matching node.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">148</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">149</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Arguments:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">150</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *  - key: "id", "text", "regex", "focus", ...</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">151</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *  - value: selector value</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">152</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment"> *<span class="cm-tab" role="presentation" cm-text="	">  </span>- timeoutMs : timeout in milliseconds</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">153</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">154</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Returns:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">155</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *  - AccessibilityNodeInfo or null if no match in timeout</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">156</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *───────────────────────────────────────────────────────────────*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">157</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def cm-overlay cm-searching cm-overlay cm-vscode-highlight">waitNodes</span><span class="cm-overlay cm-searching cm-overlay cm-vscode-highlight">(</span><span class="cm-property">String</span> <span class="cm-variable-2">key</span>, <span class="cm-property">String</span> <span class="cm-variable-2">value</span>, <span class="cm-property">long</span> <span class="cm-variable-2">timeoutMs</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">158</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">159</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-property">Object</span> <span class="cm-variable">NO_RESULT</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-def">Object</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span> &nbsp;<span class="cm-comment">/* sentinel */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">160</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">161</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">tasker</span><span class="cm-punctuation">.</span><span class="cm-def">getAccessibilityEvents</span><span class="cm-bracket">()</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">162</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">.</span><span class="cm-def">map</span><span class="cm-bracket">(</span><span class="cm-keyword">new</span> <span class="cm-def">Function</span><span class="cm-bracket">()</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">163</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-property">Object</span> <span class="cm-def">apply</span>(<span class="cm-property">Object</span> <span class="cm-variable-2">event</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">164</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">165</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">AccessibilityNodeInfo</span> <span class="cm-variable">root</span> <span class="cm-operator">=</span> <span class="cm-def">getRoot</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">166</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">root</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span><span class="cm-bracket">)</span> <span class="cm-keyword">return</span> NO_RESULT<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">167</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">168</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-property">ArrayList</span> <span class="cm-variable">nodes</span> <span class="cm-operator">=</span> <span class="cm-def">findNodes</span>(<span class="cm-variable">root</span>, <span class="cm-variable">key</span>, <span class="cm-variable">value</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">169</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-variable">nodes</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">nodes</span>.<span class="cm-def">size</span><span class="cm-bracket">()</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">170</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> nodes<span class="cm-punctuation">;</span> &nbsp;<span class="cm-comment">/* found → send real result */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">171</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">172</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">173</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> NO_RESULT<span class="cm-punctuation">;</span> &nbsp;<span class="cm-comment">/* keep waiting */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">174</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">175</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">})</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">176</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">.</span><span class="cm-def">filter</span><span class="cm-bracket">(</span><span class="cm-keyword">new</span> <span class="cm-def">Predicate</span><span class="cm-bracket">()</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">177</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">boolean</span> <span class="cm-def">test</span>(<span class="cm-property">Object</span> <span class="cm-variable-2">n</span><span class="cm-bracket">)</span> <span class="cm-bracket">{</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">178</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">n</span> <span class="cm-operator">!=</span> NO_RESULT<span class="cm-punctuation">;</span> &nbsp;<span class="cm-comment">/* ignore non-matches */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">179</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">180</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">})</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">181</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">.</span><span class="cm-def">timeout</span>(<span class="cm-variable">timeoutMs</span><span class="cm-punctuation">,</span> TimeUnit<span class="cm-punctuation">.</span>MILLISECONDS<span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">182</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">.</span><span class="cm-def">firstOrError</span><span class="cm-bracket">()</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">183</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">.</span><span class="cm-def">blockingGet</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span> <span class="cm-comment">/* will return the ArrayList when found */</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">184</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">185</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">186</div><div class="CodeMirror-gutter-elt" style="left: 54px; width: 15px;"><div class="CodeMirror-foldgutter-open CodeMirror-guttermarker-subtle"></div></div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/*───────────────────────────────────────────────────────────────</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">187</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * findNodes(AccessibilityNodeInfo root, String key, String value)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">188</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * **Find Multiple Nodes**</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">189</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Finds all UI nodes matching a selector ("id", "text", "regex", "focus").</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">190</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">191</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * Arguments:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">192</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * * - root → The starting node for the search.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">193</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * * - key → Selector type ("id", "text", etc.)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">194</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> * * - value → Selector value.</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -69px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 30px;">195</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"> *</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 34px; width: 1px; border-bottom: 0px solid transparent; top: 22795px;"></div><div class="CodeMirror-gutters" style="height: 22829px;"><div class="CodeMirror-gutter CodeMirror-lint-markers"></div><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 38px;"></div><div class="CodeMirror-gutter CodeMirror-foldgutter"></div></div></div></div></div></div>

        <div class="card" id="debugger-container" style="position: relative;">
          <div id="debugger-panel-container" class="flex-center">
            <div id="debugger-panel">
              <button id="runBtn" class="btn-ghost">Run</button>
              <button id="error-btn" class="btn-ghost">Error</button>
              <button id="return-btn" class="btn-ghost active">Return</button>
              <button id="variable-btn" class="btn-ghost">Variables <span id="variable-count" class="circle" style="display: inline-block;">16</span></button>
            </div>
            <div id="status-panel">
              <span id="status-count">Total: 74</span>
              <span id="status-pos">Ln 4, Col 2</span>
              <span id="status-sel"></span>
            </div>
            <!-- <button id="clearBtn" class="btn-ghost">Clear</button> -->
            <div id="run-status-panel">
              <span id="run-status" class="notice">Done</span></div>
          </div>
        </div>
        <p>
        </p><div class="mb-8" id="error-container">

          <div class="small flex-between mb-6">

            <button id="copyError" class="btn-ghost">Copy</button>
          </div>
          <pre id="err"></pre>
        </div>
        <div class="mb-8 active" id="return-container">
          <div class="small flex-between mb-6">
            <!-- <span>Return</span> -->
            <button id="copyReturn" class="btn-ghost">Copy</button>
          </div>
          <pre id="ret">Stopped</pre>
        </div>
        <div class="mb-8" id="vars-container">
          <div class="small flex-between mb-6">
          </div>
          <ul id="vars" class="vars-list"><li class="var-item"><div class="var-left"><div class="var-name">%json</div><div class="preview">{
  "clickable": false,
  "className": "android.app.Notification",
  "eventType": 64,
  "enabled": false,
  "viewId": "",
  "sourceClassName": "",
  "eventTime"…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log1</div><div class="preview">{
  "clickable": false,
  "className": "android.widget.RelativeLayout",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.RelativeLayou…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log10</div><div class="preview">{
  "clickable": false,
  "className": "android.widget.RelativeLayout",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.RelativeLayou…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log11</div><div class="preview">{
  "clickable": false,
  "className": "eu.kanade.tachiyomi.ui.main.MainActivity",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.Fr…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log12</div><div class="preview">{
  "clickable": true,
  "className": "android.widget.ImageView",
  "eventType": 1,
  "enabled": true,
  "contentDescription": "Home",
  "sourceClassName": "and…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log13</div><div class="preview">{
  "clickable": false,
  "className": "com.miui.home.launcher.Launcher",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.FrameLayout…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log14</div><div class="preview">{
  "clickable": false,
  "className": "android.app.Notification",
  "eventType": 64,
  "enabled": false,
  "viewId": "",
  "sourceClassName": "",
  "eventTime"…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log2</div><div class="preview">{
  "clickable": false,
  "className": "android.widget.LinearLayout",
  "eventType": 1,
  "enabled": false,
  "viewId": "",
  "sourceClassName": "",
  "eventTim…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log3</div><div class="preview">{
  "clickable": false,
  "className": "android.widget.RelativeLayout",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.RelativeLayou…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log4</div><div class="preview">{
  "clickable": false,
  "className": "org.chromium.chrome.browser.ChromeTabbedActivity",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.w…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log5</div><div class="preview">{
  "clickable": false,
  "className": "org.chromium.chrome.browser.ChromeTabbedActivity",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.w…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log6</div><div class="preview">{
  "clickable": true,
  "className": "android.widget.ImageView",
  "eventType": 1,
  "enabled": true,
  "contentDescription": "Home",
  "sourceClassName": "and…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log7</div><div class="preview">{
  "clickable": false,
  "className": "com.miui.home.launcher.Launcher",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.FrameLayout…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log8</div><div class="preview">{
  "clickable": false,
  "className": "android.widget.RelativeLayout",
  "eventType": 32,
  "enabled": true,
  "sourceClassName": "android.widget.RelativeLayou…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%log9</div><div class="preview">{
  "clickable": false,
  "className": "android.widget.LinearLayout",
  "eventType": 1,
  "enabled": false,
  "viewId": "",
  "sourceClassName": "",
  "eventTim…</div></div><div><button class="btn-ghost">Copy</button></div></li><li class="var-item"><div class="var-left"><div class="var-name">%netdinglischandroidtaskermextraprofilevariables</div><div class="preview">ImportableVariable:%directory_path:pj:103:1,ImportableVariable:%database_name:pj:103:1,ImportableVariable:%github_pat:pj:103:1</div></div><div><button class="btn-ghost">Copy</button></div></li></ul>
        </div>
    </main></div>

    
  </div>
  

  <div id="modal" class="modal-backdrop" style="display: none;">
    <div class="modal">
      <div class="flex-between mb-8">
        <strong id="modalTitle">%log9</strong>
        <div class="flex gap-8">
          <button id="copyBtn" class="btn-ghost">Copy</button>
          <button id="closeModal" class="close-x">Close</button>
        </div>
      </div>
      <pre id="modalContent">{
  "clickable": false,
  "className": "android.widget.LinearLayout",
  "eventType": 1,
  "enabled": false,
  "viewId": "",
  "sourceClassName": "",
  "eventTime": 784294147,
  "eventTypeName": "TYPE_VIEW_CLICKED",
  "sourcePackageName": "",
  "checked": false,
  "packageName": "com.appindustry.everywherelauncher",
  "text": "[Komikku]"
}</pre>
    </div>
  </div>




  <!-- Taskernet URL Modal (initially hidden) -->
  <div id="importCodeModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <div class="flex-between mb-8">
        <strong>Enter Taskernet/code URL</strong>

      </div>
      <input type="text" id="codeUrl" placeholder="https://taskernet.com/shares/?user=...&amp;id=.../other raw text URL">
      <div>
        <button id="importCode" class="btn-ghost">Fetch Codes</button>
        <button id="closeImportCodeModal" class="btn-ghost">Close</button>
      </div>
      <!-- <div id="taskernetResult" class="mt-8"></div> -->
    </div>
  </div>


  <script>
    // ------------------------------------- DOM ELEMENTS ------------------------------------- //
    const el = id => document.getElementById(id);
    const tabsList = el('tabs-list');
    const addTabBtn = el('add-tab-btn');
    const editorsContainer = el('editors-container');
    const sidebarWindow = el('sidebar-window');
    const runBtn = el('runBtn');
    const varsList = el('vars');
    const retEl = el('ret');
    const errEl = el('err');
    const statusEl = el('run-status');
    const modal = el('modal');
    const modalContent = el('modalContent');
    const modalTitle = el('modalTitle');
    const closeModal = el('closeModal');
    const copyBtn = el('copyBtn');
    const copyReturnBtn = el('copyReturn');
    const copyErrorBtn = el('copyError');
    const tasksModal = el('tasksModal');
    const taskFilter = el('taskFilter');
    const tasksList = el('tasksList');
    // const closeTasksBtn = el('closeTasks');
    const browseFileModal = el('browseFileModal');
    // const closeBrowseFileModal = el('closeBrowseFileModal');
    const currentPathEl = el('currentPath');
    const fileListEl = el('fileList');
    const mkdirBtn = el('mkdirBtn');
    const newFolderNameEl = el('newFolderName');
    const saveFileFab = el('saveFileFab');
    const fileFilterInput = el('fileFilterInput');
    const importCodeModal = el('importCodeModal');
    const closeImportCodeModal = el('closeImportCodeModal');
    const importCodeBtn = el('importCode');
    const codeUrlInput = el('codeUrl');

    const activeAlerts = [];

    // ------------------------------------- VARIABLE CONFIGURATION ------------------------------------- //
    const truncate = (s, n = 140) => !s ? '' : (String(s).length > n ? String(s).slice(0, n) + '…' : String(s));
    let demoConfig = { protocol: "http:", host: "192.168.1.9", port: "8443" };
    let runDemo = false;

    const loc = new URL(window.location.href);
    if (loc.hostname == "127.0.0.1" && loc.port == "5500") {
      runDemo = true;
    }
    const defaultConfig = {
      host: loc.hostname,
      port: loc.port || (loc.protocol === 'https:' ? '443' : '80')
    };
    const defaultTimeout = 3000;
    const runTimeout = 50000;
    const quickTimeout = 1000;
    const longTimeout = 5000;

    var editors = [];
    let activeEditorId = null;
    let tabCounter = 0;
    let lastFolderPath = "/storage/emulated/0";
    let browseMode = 'open'; // can be 'open' or 'save'
    let fileToSave = null;
    let sessionKey = 'Default';
    let { host, port } = getConfig();

    let githubPersonalAccessToken = null;

    (async () => {
      githubPersonalAccessToken = await getGithubPersonalAccessToken();

      if (!githubPersonalAccessToken) {
        showAlert('Failed to load GitHub Personal Access Token at startup.');
        return;
      }

      console.log('✅ GitHub token initialized:', githubPersonalAccessToken);
    })();




    // ------------------------------------- EDITOR CONFIGURATION ------------------------------------- //
    const EXTRAWORDS = [
      "abstract", "assert", "boolean", "break", "byte", "case", "catch", "char", "class", "const", "continue",
      "default", "do", "double", "else", "enum", "extends", "false", "final", "finally", "float", "for", "goto",
      "if", "implements", "import", "instanceof", "int", "interface", "long", "native", "new", "null", "package",
      "private", "protected", "public", "return", "short", "static", "strictfp", "super", "switch", "synchronized",
      "this", "throw", "throws", "transient", "true", "try", "void", "volatile", "while",
      "println", "print", "tasker", "context", "intent", "bundle", "cat", "cd", "clear", "exec", "exit", "load", "source", "bind", "setAccessibility",
      "JSONObject", "JSONArray", "String", "int", "boolean", "char", "float", "double", "long", "short", "byte", "Object"
    ];

    // --- CodeMirror Token Data
    const tokenData = {
      start: [
        {
          regex: /r"""/,
          token: "string",
          next: "qstring_triple_raw"
        },
        {
          regex: /"""/,
          token: "string",
          next: "qstring_triple"
        },
        {
          regex: /"(?:[^\\]|\\.)*?"/,
          token: "string"
        },
        {
          regex: /\b(true|false|null|undefined)\b/,
          token: ["atom"]
        },
        {
          regex: /\b(abstract|assert|boolean|break|byte|case|catch|char|class|const|continue|default|do|double|else|enum|extends|false|final|finally|float|for|goto|if|implements|import|instanceof|int|interface|long|native|new|null|package|private|protected|public|return|short|static|strictfp|super|switch|synchronized|this|throw|throws|transient|try|void|volatile|while)\b/,
          token: ["keyword"]
        },
        {
          regex: /\b(println|print|tasker|getVariable|setVariable|getObject|setObject|context|intent|bundle|cat|cd|clear|exec|exit|load|source|bind|setAccessibility)\b/,
          token: ["builtin"]
        },
        {
          regex: /([a-zA-Z_$][\.\w$]*)( +)([a-zA-Z_$][\w$]*)(?= *=)/i,
          token: ["property", null, "variable"]
        },
        {
          regex: /([a-zA-Z_$][\w$]*)(?= *[=<>!&?])/i,
          token: ["variable"]
        },
        {
          regex: /(,|\()( *)([a-zA-Z_$][\w$]*)( *)(?=,|\))/i,
          token: [null, null, "variable", null]
        },
        {
          regex: /(,|\()( *)([a-zA-Z_$][\.\w$]*)( +)([a-zA-Z_$][\w$]*)( *)(?=,|\))/i,
          token: [null, null, "property", null, "variable-2", null]
        },
        {
          regex: /\/\/.*/,
          token: "comment"
        },
        { regex: /\/\*/, token: "comment", next: "comment" },
        {
          regex: /"(?:[^\\]|\\.)*?"/,
          token: "string"
        },
        {
          regex: /'(?:[^\\]|\\.)*?'/,
          token: "string"
        },
        {
          regex: /\b(0x)?\d+(\.\d+)?\b/,
          token: "number"
        },
        {
          regex: /@\b(?:gt>|lt<|lteq<=|gteq>=|or\|\||and&&|bitwise_and&|bitwise_or\||left_shift<<|right_shift>>|right_unsigned_shift>>>|and_assign&=|or_assign\|=|left_shift_assign<<=|right_shift_assign>>=|right_unsigned_shift_assign>>>=)\b/,
          token: "operator"
        },
        {
          regex: /([a-zA-Z_$][\w$]*)( )([a-zA-Z_$][\w$]*)(?=\()/,
          token: ["property", null, "def"]
        },
        {
          regex: /([a-zA-Z_$][\w$]*)(?=\()/,
          token: ["def"]
        },
        {
          regex: /([a-zA-Z_$][\w$]*)(\.)([a-zA-Z_$][\w$]*)(?=\()/,
          token: ["variable", null, "def"]
        },
        {
          regex: /[+\-*/%=<>!&|?:]/,
          token: "operator"
        },
        {
          regex: /[{}]/,
          token: "bracket"
        },
        {
          regex: /[\[\]()]/,
          token: "bracket"
        },
        {
          regex: /[;,.]/,
          token: "punctuation"
        },
        {
          regex: /[a-zA-Z_$][\w$]*(?= *=)/,
          token: "variable"
        },
        {
          regex: /\s+/,
          token: null
        }
      ],  // The qstring_triple state is for inside a multiline string.
      qstring_triple: [
        // Look for the closing triple quote. The '`' is important.
        // By using `.` in the regex, it matches any character across lines.
        // The mode stays in this state until a closing `"""` is found.
        { regex: /.*?"""/, token: "string", next: "start" },
        { regex: /.*/, token: "string" }
      ],
      // Special state for raw triple-quoted strings.
      qstring_triple_raw: [
        { regex: /.*?r?"""/, token: "string", next: "start" },
        { regex: /.*/, token: "string" }
      ]
      , comment: [
        {
          regex: /.*?\*\//,
          token: "comment",
          next: "start"
        },
        {
          regex: /.*/,
          token: "comment"
        }
      ],
      meta: {
        lineComment: "//",
        blockCommentStart: "/*",
        blockCommentEnd: "*/",
        fold: "brace"
      }
    }
    const placeHolder = `THIS EDITOR DOESN'T SAVE AUTOMATICALLY.
MAKE SURE TO ALWAYS NAME AND SAVE CURRENT FILE.
THEN SAVE ALL TO SAVE ALL FILES AND REMEMBER LAST OPENED TABS.


Available shortcuts:
    
Ctrl + /      →  Toggles comments on or off for the selected lines.
                 (Adds or removes // at the start of the line.)

Ctrl + [      →  Folds (hides) all sections of code, so you only see the main structure.

Alt  + [      →  Unfolds (shows) all previously folded code sections.

Ctrl + ]      →  Folds (hides) just the current section of code where your cursor is.

Ctrl + P      →  Beautify active editor.

Ctrl + S      →  Saves your current file or tab.

Ctrl + Space  →  Opens the autocomplete menu to suggest code completions.

Esc           →  Exits fullscreen mode if the editor is currently fullscreen.

F11           →  Toggles fullscreen mode on or off for the editor.
`;
    const editorConfig = {
      autoCloseBrackets: true,
      autofocus: true,
      autorefresh: true,
      extraKeys: {
        "Ctrl-P": function (cm) {
          showAlert("Beautifying code.", 1000);
          formatActiveEditor();
        },
        "Ctrl-/": function (cm) {
          showAlert("Toggling comments.", 1000);
          cm.toggleComment();
        },
        "Ctrl-[": function (cm) {
          showAlert("Folding all code sections.", 1000);
          CodeMirror.commands.foldAll(cm);
        },
        "Ctrl-]": function (cm) {
          showAlert("Folding current code section.", 1000);
          cm.foldCode(cm.getCursor());
        },
        "Alt-[": function (cm) {
          showAlert("Unfolding all code sections.", 1000);
          CodeMirror.commands.unfoldAll(cm);
        },
        "Ctrl-S": (cm) => {
          showAlert("Saving current file.", 1000);
          saveCurrentTab(); return false;
        },
        "Ctrl-Space": (cm) => {
          CodeMirror.commands.autocomplete(cm); return false;
        }
        ,
        "Esc": cm => {
          showAlert("Exiting fullscreen mode.", 1000);
          if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
        },
        "F11": cm => {
          showAlert("Toggling fullscreen mode.", 1000);
          cm.setOption("fullScreen", !cm.getOption("fullScreen"))
        }
      },
      fixedGutter: false,
      foldGutter: true,
      gutters: [
        "CodeMirror-lint-markers",
        "CodeMirror-linenumbers",
        "CodeMirror-foldgutter"
      ],
      highlightSelectionMatches: { showToken: /\w/, annotateScrollbar: true, style: "vscode-highlight" },
      lineNumbers: true,
      lineWrapping: true,
      matchBrackets: true,
      mode: "beanshell",
      placeholder: placeHolder,
      rulers: true,
      scrollbarStyle: "overlay",
      smartIndent: true,
      styleActiveLine: true,
      theme: "blackboard",
      // Indentation
      indentWithTabs: true,
      tabSize: 4
    }
    const sidebarConfig = [
      {
        title: "Session",
        icon: "codicon codicon-project",
        function: function () {
          showAlert("Session: " + sessionKey);
          showAlert("Function is not available yet.");
        }
      },
      {
        title: "Open File",
        icon: "codicon codicon-files",
        function: function () {
          openFileBrowser('open');
        }
      },
      {
        title: "Save All",
        icon: "codicon codicon-save-all",
        function: function () {
          saveAllTabs();
        }
      },
      {
        title: "Select Task Before Run",
        icon: "codicon codicon-sort-precedence",
        function: async function () {
          expandSidebarWindow();
          const tasks = await fetchTasks();
          showTasksModal(tasks);
        }
      },
      {
        title: "Import Code",
        icon: "codicon codicon-cloud-download",
        function: function () {
          importCodeModal.style.display = 'flex';
          codeUrlInput.value = '';
          codeUrlInput.focus();
        }
      },
      {
        title: "Sync Repository",
        icon: "codicon codicon-github",
        function: function () {
          // showAlert("Session: " + sessionKey);
          code = `
import android.content.Intent;
import android.content.ComponentName;

startGitSync() {
    intent = new Intent();
    intent.setAction("INTENT_SYNC");
    intent.setComponent(new ComponentName("com.viscouspot.gitsync", "com.viscouspot.gitsync.GitSyncService"));
    context.startForegroundService(intent);
}

startGitSync();`;
          runCode(code, null, quickTimeout);
          showAlert("Trigger Sync Service for GitSync.");
        }
      },
      {
        title: "Create/Update Gist",
        icon: "codicon codicon-gist-secret",
        function: function () {
          showAlert("Creating/Updating GitHub Gist.");
          createGistForCurrentTab();
        }
      }
    ];


    // --- CodeMirror Editor
    window.addEventListener("cdnLoaded", () => {
      // --- CodeMirror Setup ---
      registerCustomCodeMirrorHint();
      CodeMirror.defineSimpleMode("beanshell", tokenData);
      createSidebar(sidebarConfig, 'body', window.cm);
    });


    // ------------------------------------- CODE MIRROR FUNCTIONS ------------------------------------- //

    // --- CodeMirror Hinting (IIFE) ---    
    function registerCustomCodeMirrorHint() {
      "use strict";
      const WORD = /[\w$]+(\([^\(\)"']*?\))?/;
      const RANGE = 500;
      window.fetchedMethods = window.fetchedMethods || [];

      function dynamicHint(cm, self, data) {
        const cursor = cm.getCursor();
        const line = cm.getLine(cursor.line);
        let start = cursor.ch;
        while (start && /[\w$]/.test(line.charAt(start - 1))) start--;
        cm.replaceRange(data.text, { line: cursor.line, ch: start }, cursor);
      }

      function fuzzyMatch(needle, haystack) {
        needle = needle.toLowerCase();
        haystack = haystack.toLowerCase();
        let i = 0, j = 0;
        while (i < needle.length && j < haystack.length) {
          if (needle[i] === haystack[j]) i++;
          j++;
        }
        return i === needle.length;
      }

      // Calculate closeness score for sorting
      function fuzzyScore(needle, haystack) {
        needle = needle.toLowerCase();
        haystack = haystack.toLowerCase();
        let score = 0, i = 0, j = 0;
        while (i < needle.length && j < haystack.length) {
          if (needle[i] === haystack[j]) {
            score += 2;
            if (j > 0 && haystack[j - 1] === needle[i - 1]) score += 1;
            i++;
          }
          j++;
        }
        return i === needle.length ? score : 0;
      }

      // Highlight matched letters for display
      function highlightMatch(text, pattern) {
        if (!pattern) return text;
        const lowerText = text.toLowerCase();
        const lowerPattern = pattern.toLowerCase();
        let result = "";
        let t = 0, p = 0;
        while (t < text.length) {
          if (p < lowerPattern.length && lowerText[t] === lowerPattern[p]) {
            result += `<span class="cm-hint-match">${text[t]}</span>`;
            p++;
          } else {
            result += text[t];
          }
          t++;
        }
        return result;
      }

      CodeMirror.registerHelper("hint", "custom", async (editor, options = {}) => {
        if (!editor) return;
        const word = options.word || WORD;
        const range = options.range || RANGE;
        let extraWords = options.extraWords || EXTRAWORDS;
        const cur = editor.getCursor();
        const curLine = editor.getLine(cur.line);
        let end = cur.ch;
        let start = end;
        while (start && word.test(curLine.charAt(start - 1))) start--;
        const curWord = start !== end ? curLine.slice(start, end) : "";
        const list = [];
        const seen = {};
        const re = new RegExp(word.source, "gi");
        let objectBeforeDot = null;
        const lastChar = curLine.charAt(end - 1);
        if (lastChar === "." || lastChar === ")") {
          let i = end - 2;
          let parenCount = 0;
          if (lastChar === ')') parenCount++;
          if (curLine.charAt(i) === ')') {
            parenCount++;
            i--;
          }
          while (i >= 0 && parenCount > 0) {
            if (curLine.charAt(i) === ')') parenCount++;
            else if (curLine.charAt(i) === '(') parenCount--;
            i--;
          }
          while (i >= 0 && /[\w$.]/.test(curLine.charAt(i))) i--;
          if (lastChar === '.') objectBeforeDot = curLine.slice(i + 1, end - 1);
          else objectBeforeDot = curLine.slice(i + 1, end);

          function createHintFromSignature(fullSignature, curWord, objectName = null) {
            const fullMatch = fullSignature.replace(/\/\*.*?\*\//g, ''); // Strip comments
            const nameMatch = fullMatch.match(/(?:\.|^)([\w$]+)\s*\(/);
            const methodName = nameMatch ? nameMatch[1] : fullMatch.split('(')[0].split('.').pop();

            const argsMatch = fullMatch.match(/\(([^)]*)\)/);
            let insertText = methodName + '()';
            let displayText = methodName + '()';
            let subtext = null;

            if (argsMatch) {
              const args = argsMatch[1].trim();
              if (args) {
                const argList = args.split(',').map(s => s.trim().split('.').pop().split(' ')[0]);
                const displayArgs = argList.join(', ');
                const insertArgs = argList.map(() => '').join(', ');
                displayText = `${methodName}(${displayArgs})`;
                insertText = `${methodName}(${insertArgs})`;
              }
            }

            // Check if it's a full Java-like declaration to decide on subtext
            if (/\s/.test(fullMatch.trim().split('(')[0]) && fullMatch.includes('.')) {
              subtext = fullMatch;
            }

            return {
              text: insertText,
              displayText: displayText,
              hint: dynamicHint,
              subtext: subtext,
              objectName: objectName,
              render: function (el) {
                const highlighted = highlightMatch(this.displayText, curWord);
                const title = this.subtext || this.displayText;
                if (this.subtext) {
                  el.innerHTML = `<div class="CodeMirror-hints-title" title="${title}">${highlighted}</div><div class="CodeMirror-hints-subtext">${this.subtext}</div>`;
                } else {
                  el.innerHTML = `<div class="CodeMirror-hints-title" title="${title}">${highlighted}</div>`;
                }
              }
            };
          }

          if (objectBeforeDot) {
            window.fetchedMethods = [];
            try {
              const fetchObject = objectBeforeDot;
              const importList = getImportsFromEditor(editor);

              const url = `http://${host}:${port}/java/api/object`;
              const body = JSON.stringify({ object: fetchObject, import: importList });
              const controller = createAbortController(quickTimeout);
              const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body,
                signal: controller.signal
              });
              if (response.ok) {
                const data = await response.json();
                if (Array.isArray(data)) {
                  const methods = data.map(fullLine => createHintFromSignature(fullLine, curWord, fetchObject));
                  window.fetchedMethods = [...methods, ...window.fetchedMethods.filter(m => m.objectName !== fetchObject)];
                }
              }
            } catch (err) { console.error("Fetch failed:", err); }
          }
        }
        if (window.fetchedMethods.length) {
          const matchingMethods = window.fetchedMethods.filter(item => (!objectBeforeDot || item.objectName === objectBeforeDot) && fuzzyMatch(curWord, item.text));
          if (matchingMethods.length) {
            extraWords = [...matchingMethods, ...EXTRAWORDS];
          }
          else if (objectBeforeDot) {
            window.fetchedMethods = window.fetchedMethods.filter(m => m.objectName !== objectBeforeDot);
          }
        }
        let extraList = [];
        extraWords.forEach(w => {
          const item = typeof w === "string" ? {
            text: w,
            displayText: w,
            hint: dynamicHint,
            render: el => {
              const highlighted = highlightMatch(w, curWord);
              el.innerHTML = `<div class="CodeMirror-hints-title" title="${w}">${highlighted}</div>`;
            }
          } : {
            ...w,
            render: el => {
              const highlighted = highlightMatch(w.displayText || w.text, curWord);
              const title = w.subtext || w.text || '';
              // If has subtext → show two-line render (like VS Code)
              if (w.subtext) {
                el.innerHTML = `<div class="CodeMirror-hints-title" title="${title}">${highlighted}</div><div class="CodeMirror-hints-subtext">${w.subtext}</div>`;
              } else {
                el.innerHTML = `<div class="CodeMirror-hints-title" title="${title}">${highlighted}</div>`;
              }
            }
          };

          if (item.text && fuzzyMatch(curWord, item.text) && !seen[item.text]) {
            seen[item.text] = true;
            extraList.push(item);
          }
        });

        extraList.sort((a, b) =>
          fuzzyScore(curWord, b.text) - fuzzyScore(curWord, a.text)
        );
        let docList = [];
        [-1, 1].forEach(dir => {
          let line = cur.line;
          const endLine = Math.min(Math.max(line + dir * 500, editor.firstLine()), editor.lastLine()) + dir;
          while (line !== endLine) {
            const text = editor.getLine(line);
            let m;
            while ((m = re.exec(text))) {
              if (line === cur.line && m[0] === curWord) continue;
              if ((!curWord || fuzzyMatch(curWord, m[0])) && !seen[m[0]]) {
                seen[m[0]] = true;
                const fullMatch = m[0].replace(/\/\*.*?(\*\/)?/g, '');
                const methodNameMatch = fullMatch.match(/^[\w$]+/);
                const methodName = methodNameMatch ? methodNameMatch[0] : fullMatch;
                const argsMatch = fullMatch.match(/\((.*)\)/);
                let insertText = fullMatch, displayText = fullMatch, displayHTML = fullMatch;
                if (argsMatch) {
                  const args = argsMatch[1].split(',').map(s => s.trim().split(' ')[0]);
                  insertText = methodName + '(' + args.map(() => "").join(", ") + ')';
                  displayText = methodName + '(' + args.join(', ') + ')';
                }
                const highlighted = highlightMatch(displayText, curWord);
                docList.push({
                  text: insertText,
                  displayText: displayText,
                  hint: dynamicHint,
                  render: el => {
                    displayHTML = `<div class="CodeMirror-hints-title" title="${fullMatch}"">${highlighted}</div>`;
                    el.innerHTML = displayHTML;
                  }
                });
              }
            }
            line += dir;
          }
        });
        docList.sort((a, b) => {
          const aFunc = a.text.includes(")");
          const bFunc = b.text.includes(")");
          if (aFunc !== bFunc) return aFunc ? -1 : 1;
          return a.text.localeCompare(b.text);
        });
        list.push(...extraList, ...docList);
        return { list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
      });
      CodeMirror.commands.autocomplete = cm => { cm.showHint({ hint: CodeMirror.hint.custom, editor: cm }); };
    }

    // --- Core Functions ---
    // function createNewEditor(config = null) {
    //   const editorWrapper = document.createElement('div');
    //   editorWrapper.className = 'editor-wrapper';

    //   const textArea = document.createElement('textarea');
    //   editorWrapper.appendChild(textArea);
    //   editorsContainer.appendChild(editorWrapper);

    //   const newEditor = CodeMirror.fromTextArea(textArea, editorConfig);
    //   // newEditor.setValue(value);
    //   newEditor.setSize(null, '70vh');
    //   if (config !== null) setEditorState(newEditor, config);

    //   let hintTimer;

    //   newEditor.on("inputRead", function (cm, change) {
    //     // Ignore paste, undo, redo, or programmatic updates
    //     // , "setValue",
    //     if (["paste", "undo", "redo"].includes(change.origin)) return;

    //     // Clear any existing pending hint
    //     clearTimeout(hintTimer);

    //     // Only trigger hint for valid character input
    //     if (change.text[0] && /[a-zA-Z0-9_.]/.test(change.text[0])) {
    //       hintTimer = setTimeout(() => {
    //         if (!cm.state.completionActive) { // avoid re-triggering while open
    //           cm.showHint({
    //             hint: CodeMirror.hint.custom,
    //             completeSingle: false,
    //             editor: cm
    //           });
    //         }
    //       }, 100); // adjust delay (ms) as you like
    //     }
    //   });
    //   return { editor: newEditor, wrapper: editorWrapper };
    // }

    function createNewEditor(config = null) {
      const editorWrapper = document.createElement('div');
      editorWrapper.className = 'editor-wrapper';
      let panelNode;

      const textArea = document.createElement('textarea');
      editorWrapper.appendChild(textArea);
      editorsContainer.appendChild(editorWrapper);

      const newEditor = CodeMirror.fromTextArea(textArea, editorConfig);
      // newEditor.setSize(null, '70vh');
      if (config !== null) setEditorState(newEditor, config);

      //──────────────────────────────────────────────
      //  Autocomplete logic
      //──────────────────────────────────────────────
      let hintTimer;
      newEditor.on("inputRead", function (cm, change) {
        if (["paste", "undo", "redo"].includes(change.origin)) return;
        clearTimeout(hintTimer);
        if (change.text[0] && /[a-zA-Z0-9_.]/.test(change.text[0])) {
          hintTimer = setTimeout(() => {
            if (!cm.state.completionActive) {
              cm.showHint({
                hint: CodeMirror.hint.custom,
                completeSingle: false,
                editor: cm
              });
            }
          }, 100);
        }
      });

      newEditor.on("cursorActivity", () => updateStatus(newEditor));
      newEditor.on("change", () => updateStatus(newEditor));
      //──────────────────────────────────────────────
      //  Status Panel (live cursor / selection / text count)
      //──────────────────────────────────────────────
      // panelNode = document.createElement("div");
      // panelNode.className = "code-editor-status-panel"; // user can style this class

      // const countSpan = document.createElement("span");
      // const positionSpan = document.createElement("span");
      // const selectionSpan = document.createElement("span");

      // panelNode.appendChild(countSpan);
      // panelNode.appendChild(positionSpan);
      // panelNode.appendChild(selectionSpan);


      // Helper to update status text
      // const updateStatus = () => {
      //   const cursor = newEditor.getCursor();
      //   const sel = newEditor.getSelection();
      //   const total = newEditor.getValue().length;
      //   const activeEditorData = getActiveEditorData();
      //   countSpan.textContent = ` Total: ${total}`;
      //   positionSpan.textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1} `;
      //   selectionSpan.textContent = sel
      //     ? `(${sel.length} selected)`
      //     : "";
      // };

      // newEditor.on("cursorActivity", updateStatus);
      // newEditor.on("change", updateStatus);
      // updateStatus();

      // // Add the panel to bottom
      // newEditor.addPanel(panelNode, {
      //   position: "bottom",
      //   stable: true
      // });

      return { editor: newEditor, wrapper: editorWrapper, statusPanel: panelNode };
    }

    // ------------------------------------- EDITOR FUNCTIONS ------------------------------------- //
    function createSidebar(config, containerSelector = 'body', cm = null) {
      // const sidebar = document.createElement('div');
      // sidebar.className = 'sidebar';
      sidebar = document.querySelector('.sidebar');
      config.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'sidebar-btn';
        btn.setAttribute('icon-title', item.title); // tooltip text (on hover)

        let hasValidIcon = false;
        const iconContainer = document.createElement('div');
        iconContainer.className = 'icon-container';

        if (item.icon) {
          if (/^https?:\/\//.test(item.icon) || /\.(png|jpg|jpeg|gif|svg|webp)$/i.test(item.icon)) {
            // URL or local file path
            const img = document.createElement('img');
            img.src = item.icon;
            img.alt = item.title || 'icon';
            img.className = 'sidebar-icon-img';
            img.onerror = () => { // fallback if image fails
              iconContainer.textContent = item.title || '?';
            };
            iconContainer.appendChild(img);
            hasValidIcon = true;
          } else if (/^(fa[\s\-]|bi[\s\-]|mdi[\s\-]|icon-)/.test(item.icon)) {
            // Font Awesome / Bootstrap Icons / Material Design / etc.
            const i = document.createElement('i');
            i.className = item.icon;
            iconContainer.appendChild(i);
            hasValidIcon = true;
          } else if (/^[\p{Emoji}\w]$/u.test(item.icon)) {
            // single emoji or symbol
            const span = document.createElement('span');
            span.textContent = item.icon;
            iconContainer.appendChild(span);
            hasValidIcon = true;
          } else if (/^(fa[\s\-]|bi[\s\-]|mdi[\s\-]|icon-|codicon[\s\-])/.test(item.icon)) {
            const i = document.createElement('i');
            i.className = item.icon;
            iconContainer.appendChild(i);
            hasValidIcon = true;
          }
        }

        // fallback: show text if no valid icon
        if (!hasValidIcon) {
          const fallback = document.createElement('span');
          fallback.textContent = item.title || '?';
          iconContainer.appendChild(fallback);
        }

        btn.appendChild(iconContainer);

        // Add click event
        btn.addEventListener('click', () => {
          if (typeof item.function === 'function') {
            item.function(cm);
          }
        });

        sidebar.appendChild(btn);
      });

      // makeResizable(sidebar, { horizontal: true, collapseThreshold: "100px", collapseFallback: "50px" });
      document.querySelector(containerSelector).prepend(sidebar);
    }

    function hideOtherChildren(parentId, exceptId) {
      const parent = document.getElementById(parentId);
      if (!parent) return;

      [...parent.children].forEach(child => {
        const id = child.id || "";

        // Skip children whose id starts with "resize-handle"
        if (id.startsWith("resize-handle")) return;

        // Show only the exceptId element
        child.style.display = (id === exceptId) ? "flex" : "none";
        // child.style.visibility = (id === exceptId) ? "visibile !important" : "hidden !important";
      });
    }

    function expandSidebarWindow() {
      console.log('Expanding sidebar from: ' + sidebarWindow.style.width);
      if (sidebarWindow.style.width === '' || sidebarWindow.style.width === '0px') sidebarWindow.style.width = '45vh';
    }

    function makeTabDraggable(tabItem) {
      tabItem.setAttribute('draggable', true);

      tabItem.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', tabItem.dataset.tabId);
        tabItem.style.opacity = '0.5';
      });

      tabItem.addEventListener('dragend', () => {
        tabItem.style.opacity = '1';
      });

      tabItem.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      tabItem.addEventListener('drop', (e) => {
        e.preventDefault();
        const draggedTabId = e.dataTransfer.getData('text/plain');
        const draggedTab = document.querySelector(`.tab-item[data-tab-id='${draggedTabId}']`);

        if (draggedTab && draggedTab !== tabItem) {
          const parent = tabItem.parentNode;
          const children = Array.from(parent.children);
          const draggedIndex = children.indexOf(draggedTab);
          const dropIndex = children.indexOf(tabItem);

          if (draggedIndex < dropIndex) {
            parent.insertBefore(draggedTab, tabItem.nextSibling);
          } else {
            parent.insertBefore(draggedTab, tabItem);
          }
        }
      });
    }

    function addNewTab(config = {}) {
      let defaults = {
        tabTitle: null,
        tabId: null,
        code: '',
        title: undefined,
        run: null,
        selectedTask: null,
        file: null,
        gist: null,
        selections: null,
        marks: null,
        scroll: null,
        cursor: null,
        history: null,
        historySize: null,
      };

      // Merge defaults first, so config always has every key
      config = { ...defaults, ...config };

      // Now destructure with let (so you can modify the vars later)
      let {
        tabTitle,
        tabId,
        code,
        title,
        run,
        selectedTask,
        file,
        gist,
        selections,
        marks,
        scroll,
        cursor,
        history,
        historySize
      } = config;

      tabCounter++;
      tabId = tabCounter;
      tabTitle = title || `Untitled-${tabId}`;

      const { editor, wrapper, statusPanel } = createNewEditor(config);
      config.editor = editor;
      config.wrapper = wrapper;
      config.statusPanel = statusPanel;
      editor.scrollIntoView(editor.getCursor());

      const tab = document.createElement('div');
      tab.className = 'tab-item';
      tab.dataset.tabId = tabId;

      const titleSpan = document.createElement('span');
      titleSpan.textContent = tabTitle;

      const closeSpan = document.createElement('span');
      closeSpan.className = 'tab-close';
      closeSpan.innerHTML = '✕';

      tab.appendChild(titleSpan);
      tab.appendChild(closeSpan);
      tabsList.appendChild(tab);

      let updatedConfig = {
        tabTitle,
        tabId,
        code,
        title,
        run,
        selectedTask,
        file,
        gist,
        selections,
        marks,
        scroll,
        cursor,
        history,
        historySize,
        editor,
        wrapper,
        statusPanel,
        tab
      };

      editors.push(updatedConfig);

      setActiveTab(tabId);

      tab.addEventListener('click', () => {
        setActiveTab(tabId);
        showAlert(editors[tabId].gist.id);
      });

      titleSpan.addEventListener('dblclick', () => {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = titleSpan.textContent;
        input.className = 'tab-title-input';
        tab.replaceChild(input, titleSpan);
        input.focus();
        input.select();

        const saveTitle = () => {
          input.removeEventListener('blur', saveTitle);
          input.removeEventListener('keydown', handleKeyDown);

          const newTitle = input.value.trim() || `Untitled-${tabId}`;
          titleSpan.textContent = newTitle;

          const editorData = editors.find(e => e.tabId === tabId);
          if (editorData) {
            // Update the title
            editorData.title = newTitle;
            // ─── Update file details if available ───
            if (editorData.file && editorData.file.path && editorData.file.name) {
              const oldPath = editorData.file.path;
              const lastSlash = oldPath.lastIndexOf('/');
              const directory = oldPath.substring(0, lastSlash + 1);

              // If the title doesn't have an extension, use .txt by default
              const hasExt = /\.[a-zA-Z0-9]+$/.test(newTitle);
              const newFileName = hasExt ? newTitle : `${newTitle}.txt`;

              editorData.file.name = newFileName;
              editorData.file.path = directory + newFileName;
              console.log('Updated file details:', editorData.file);
            }
          }

          // ─── Replace input back with title span ───
          if (input.parentNode === tab) {
            tab.replaceChild(titleSpan, input);
          }
        };


        const handleKeyDown = (e) => {
          if (e.key === 'Enter') {
            saveTitle();
          } else if (e.key === 'Escape') {
            input.removeEventListener('blur', saveTitle);
            input.removeEventListener('keydown', handleKeyDown);
            if (input.parentNode === tab) {
              tab.replaceChild(titleSpan, input);
            }
          }
        };

        input.addEventListener('blur', saveTitle);
        input.addEventListener('keydown', handleKeyDown);
      });

      closeSpan.addEventListener('click', (e) => {
        e.stopPropagation();
        closeTab(tabId);
      });

      makeTabDraggable(tab);
    }

    function setActiveTab(tabId) {
      console.log("Activating tab id: ", tabId);
      activeEditorId = tabId;
      console.log("tabId:", tabId);
      let activeRunResult = null;
      let activeEditorData = null;
      let activeEditor = null;
      editors.forEach(item => {
        const isActive = item.tabId === tabId;
        item.tab.classList.toggle('active', isActive);
        item.wrapper.classList.toggle('active', isActive);
        if (isActive) {
          activeEditorData = item;
          activeEditorData.editor.focus();
          activeEditorData.editor.refresh();
        }
      });
      editor = getActiveEditor();
      editor.refresh();
      clearOutputs();
      displayRunResult(activeEditorData);
    }


    /*
     * Closes the tab with the given id.
     *
     * @param {string} tabId - the id of the tab to close.
     *
     * If the tab is currently active, it will select the previous tab if available.
     * If there are no more tabs, it will set the activeEditorId to null.
     * The task button will be updated to reflect the new active tab.
     */
    function closeTab(tabId) {
      const index = editors.findIndex(item => item.tabId === tabId);
      if (index === -1) return;

      const [closedItem] = editors.splice(index, 1);
      closedItem.tab.remove();
      closedItem.wrapper.remove();

      if (activeEditorId === tabId) {
        if (editors.length > 0) {
          const newActiveIndex = Math.max(0, index - 1);
          setActiveTab(editors[newActiveIndex].tabId);
        } else {
          activeEditorId = null;
        }
      }

    }

    function getActiveEditorData() {
      if (activeEditorId === null) return null;
      return editors.find(e => e.tabId === activeEditorId);
    }

    function getActiveEditor() {
      const active = getActiveEditorData();
      return active ? active.editor : null;
    }

    function getEditorState(editor) {
      if (!editor) return null;

      const doc = editor.getDoc();
      const marks = doc.getAllMarks();
      const state = {
        value: editor.getValue(),
        cursor: doc.getCursor(),
        scroll: editor.getScrollInfo(),
        selections: doc.listSelections(),
        marks: [],
        history: doc.getHistory(),
        historySize: doc.historySize()
      };

      if (marks.length) {
        // Reverse iterate so nested folds are handled correctly
        for (let i = marks.length - 1; i >= 0; i--) {
          const mark = marks[i];
          if (mark.collapsed && mark.type === 'range') {
            const range = mark.find();
            if (range && range.from) {
              state.marks.push(range.from);
            }
          }
        }
      }

      return state;
    }

    function setEditorState(editor, state) {
      if (!editor || !state) return;

      const doc = editor.getDoc();

      // Restore text content
      if (typeof state.value === "string") {
        editor.setValue(state.value);
      }

      if (typeof state.code === "string") {
        editor.setValue(state.code);
      }
      if (state.history !== null) {
        doc.setHistory(state.history);
      }

      // Restore selections or cursor
      if (Array.isArray(state.selections) && state.selections.length > 0) {
        doc.setSelections(state.selections);
      } else if (state.cursor) {
        doc.setCursor(state.cursor);
      }

      // Restore folded code marks
      if (Array.isArray(state.marks) && state.marks.length > 0) {
        for (const pos of state.marks) {
          if (pos) editor.foldCode(pos);
        }
      }

      // Restore scroll position
      if (state.scroll && typeof state.scroll.top === "number") {
        const left = state.scroll.left || 0;
        editor.scrollTo(left, state.scroll.top);
        console.log("Scrolling to:", left, state.scroll.top);
      }
    }

    function updateStatus(editor = null) {
      if (editor === null) editor = getActiveEditor();

      const cursor = editor.getCursor();
      const sel = editor.getSelection();
      const total = editor.getValue().length;
      const token = editor.getTokenAt(cursor);

      // Elements inside status-panel
      const countSpan = document.getElementById("status-count");
      const positionSpan = document.getElementById("status-pos");
      const selectionSpan = document.getElementById("status-sel");
      let selectionText = '';
      if (token.type != null) selectionText = `${token.string} (${token.type})`;
      countSpan.textContent = `Total: ${total}`;
      positionSpan.textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
      selectionSpan.textContent = sel.length > 0 ? `(${sel.length} selected)` : selectionText;
    }

    async function saveCurrentTab() {
      const activeEditorData = getActiveEditorData();
      if (!activeEditorData) {
        showAlert('No active tab to save.');
        return;
      }

      const url = `http://${host}:${port}/java/api/save`;
      let { title, editor, run, file, gist, selectedTask } = activeEditorData;
      console.log("Saving this file from save button:" + title + "File: " + file + "Task: " + selectedTask);
      let { value, selections, marks, scroll, cursor, history, historySize } = getEditorState(editor);
      let code = value;
      if (file == null) {
        openFileBrowser('save', { code: code });
        return;
      } else {
        const tabData = { title, run, file, gist, selectedTask, selections, marks, scroll, cursor, history, historySize };
        const formData = new FormData();
        const fileName = file?.name || `${title}.txt`;
        const fileBlob = new File([code], fileName, { type: "text/plain" });
        console.log(JSON.stringify(tabData, null, 2));
        formData.append("files", fileBlob, fileName);
        formData.append("metadata", JSON.stringify(tabData, null, 2));
        try {
          const controller = createAbortController(defaultTimeout);
          const response = await fetch(url, {
            method: "POST",
            body: formData,
            signal: controller.signal
          });

          if (response.ok) {
            showAlert(`File "${fileName}" saved successfully.`);
            openFileBrowser('open');
          } else {
            showAlert(`Error saving file: ${await response.text()}`);
          }
        } catch (err) {
          console.error(`Error saving file: ${err.message}, tabData: ${tabData}`);
          showAlert(`Failed to save: ${err.message}`, 3000, 'error');
        }
      }
    }

    async function saveAllTabs() {
      if (editors.length === 0) {
        showAlert('No tabs to save.');
        return;
      }

      const url = `http://${host}:${port}/java/api/saveAll`;
      const formData = new FormData();
      const filesToSave = editors.map(({ title, editor, run, selectedTask, file, gist }) => {
        const { value, selections, marks, scroll, cursor, history, historySize } = getEditorState(editor);
        const code = value;
        const fileName = file?.name || `${title}.txt`;
        const fileBlob = new File([code], fileName, { type: "text/plain" });
        formData.append("files", fileBlob, fileName);
        return { title, run, selectedTask, file, gist, selections, marks, scroll, cursor, history, historySize };
      });

      formData.append("metadata", JSON.stringify({
        codes: filesToSave,
        time: Math.floor(Date.now() / 1000),
        sessionKey: sessionKey
      }));

      try {
        const controller = createAbortController(longTimeout);
        const response = await fetch(url, {
          method: "POST",
          body: formData,
          signal: controller.signal
        });

        if (response.ok) {
          showAlert('All tabs saved successfully.');
        } else {
          showAlert(`Error saving tabs: ${await response.text()}`);
        }
      } catch (err) {
        showAlert(`Failed to save tabs: ${err.message}`);
      }
    }




    function addBeautifyIgnoreForTripleQuotes(code) {
      return code.replace(/( *"""[\s\S]*?""" *;?)/g, '/* beautify preserve:start */$1/* beautify preserve:end */');
    }

    function removeBeautifyIgnoreComments(code) {
      return code.replace(/\n?\t*?\/\*\s*beautify\s+preserve:(start|end)\s*\*\//g, '');
    }
    function formatActiveEditor() {
      const activeEditor = getActiveEditor();
      if (activeEditor) {
        // 1. Get the current text from the editor
        const javaText = activeEditor.getValue();
        const javaTextEscaped = addBeautifyIgnoreForTripleQuotes(javaText);
        const scrollInfo = activeEditor.getScrollInfo();
        const contentScrollableHeight = scrollInfo.height - scrollInfo.clientHeight;
        let scrollPercentage = 0;

        if (contentScrollableHeight > 0) {
          scrollPercentage = scrollInfo.top / contentScrollableHeight;
        }
        // 2. Format the text using Prettier
        const formattedText = js_beautify(javaTextEscaped, {
          // indent_size: 1,
          // indent_char: "  ",
          indent_with_tabs: true
          , brace_style: "none,preserve-inline"
          , preserve_newlines: true
          , max_preserve_newlines: 4
        });

        // 3. Set the formatted text back into the editor
        javaTextRemoved = removeBeautifyIgnoreComments(formattedText);
        activeEditor.setValue(javaTextRemoved);
        const newScrollInfo = activeEditor.getScrollInfo();
        const newContentScrollableHeight = newScrollInfo.height - newScrollInfo.clientHeight;

        // Calculate the new 'top' scroll value
        const newScrollTop = newContentScrollableHeight * scrollPercentage;

        // c. Scroll the editor to the new absolute position
        activeEditor.scrollTo(scrollInfo.left, newScrollTop);
        // activeEditor.focus();
      }
    }

    async function loadSession(sessionData) {
      if (sessionData && Array.isArray(sessionData.codes)) {
        // Clear existing tabs before loading new ones
        while (editors.length > 0) {
          closeTab(editors[0].tabId);
        }

        const readUrl = `http://${host}:${port}/fileBrowser/api/read`;

        const tabPromises = sessionData.codes.map(async tabData => {
          let code = tabData.code || null; // Fallback for tabs without a file
          if (tabData.file && tabData.file.path) {
            try {
              const controller = createAbortController(defaultTimeout);
              const response = await fetch(readUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: tabData.file.path }),
                signal: controller.signal
              });
              if (response.ok) {
                code = await response.text();
              } else {
                showAlert(`Failed to load file content for ${tabData.file.path}`);
                console.error(`Failed to load file content for ${tabData.file.path}`);
              }
            } catch (err) {
              showAlert(`Error fetching file content for ${tabData.file.path}:`, err);
              console.error(`Error fetching file content for ${tabData.file.path}:`, err);
            }
          }
          tabData.code = code;
          return tabData;
        });

        const tabsData = await Promise.all(tabPromises);
        let failedTab = [];
        let successTab = [];
        tabsData.forEach(tabData => {
          if (tabData.code != null) {
            addNewTab(tabData);
            successTab.push(tabData.title);
          } else {
            failedTab.push(tabData.title);
          }
        });

        // Activate the first tab if it exists
        if (editors.length > 0) {
          setActiveTab(editors[0].tabId);
        }
        if (failedTab.length > 0) {
          showAlert("Failed to load Tab:\n" + failedTab.join("\n"));
        } else {
          sessionKey = sessionData.sessionKey;
          showAlert(sessionKey + ' session loaded successfully.');
        }
        console.log(successTab.length);
        if (successTab.length < 1) {
          addNewTab();
        }
      } else {
        showAlert('Invalid session data format.');
        console.error("Invalid session data:", sessionData);
      }
    }

    function createAbortController(timeout = 3000, reason = 'Request timed out') {
      const controller = new AbortController();
      setTimeout(() => controller.abort(reason), timeout);
      return controller;
    }

    async function loadLastSession() {
      try {
        const controller = createAbortController(defaultTimeout);
        const url = `http://${host}:${port}/java/api/loadLastSession`;
        const response = await fetch(url, { signal: controller.signal });
        if (response.ok) {
          const sessionData = await response.json();
          if (sessionData && sessionData.codes && sessionData.codes.length > 0) {
            loadSession(sessionData);
          } else {
            addNewTab(); // Fallback to a new tab if session is empty
          }
        } else {
          showAlert("Failed loading last session.");
          addNewTab(); // Fallback if the request fails
        }
      } catch (err) {
        showAlert("Failed loading last session.\n" + err);
        console.error('Failed to load last session:', err);
        addNewTab(); // Fallback in case of an error
      }
    }

    function clearEditorErrors(editor) {
      // 1️⃣ Clear built-in lint markers
      if (typeof editor.performLint === 'function') {
        editor.performLint([]);
      }

      // 2️⃣ Clear manual line highlights and gutter icons
      const doc = editor.getDoc();
      const lastLine = doc.lineCount();
      for (let i = 0; i < lastLine; i++) {
        editor.removeLineClass(i, "background", "cm-error-line");
        editor.removeLineClass(i, "gutter", "cm-error-gutter");
        editor.setGutterMarker(i, "CodeMirror-lint-markers", null);
      }
    }

    const updateVariableCount = () => {
      // Find the count of list items (excluding those with .notice)
      const variableCount = varsList?.querySelectorAll("li.var-item")?.length || 0;
      const variableCountEl = el("variable-count");

      // Guard clauses to prevent accidental updates
      if (!variableCountEl) return; // Skip if element doesn't exist
      if (variableCount <= 0) {     // Hide if count is 0 or invalid
        variableCountEl.style.display = "none";
        return;
      }

      // Update safely only when element exists and count > 0
      variableCountEl.textContent = variableCount;
      variableCountEl.style.display = "inline-block";
    };

    const observeVariableLists = () => {
      const cards = document.querySelectorAll(".card");

      cards.forEach(card => {
        const varsList = card.querySelector(".vars-list");
        if (!varsList) return;

        const observer = new MutationObserver(updateVariableCount);
        observer.observe(varsList, {
          childList: true,
          subtree: false
        });
      });

      // Initial update
      updateVariableCount();
    };

    document.addEventListener("DOMContentLoaded", observeVariableLists);


    // ------------------------------------- FILE BROWSER FUNCTIONS ------------------------------------- //
    async function browsePath(path) {
      try {
        const controller = createAbortController(defaultTimeout);
        const url = `http://${host}:${port}/fileBrowser/api/list`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path }),
          signal: controller.signal
        });
        if (response.ok) {
          const data = await response.json();
          lastFolderPath = data.path;
          renderFileList(data.path, data.items);
        } else {
          showAlert(`Error listing path: ${await response.text()}`);
        }
      } catch (err) {
        showAlert(`Failed to browse path: ${err.message}`);
        console.error('Browse path failed:', err);
      }
    }

    function renderFileList(path, items) {
      // Render the current path as clickable breadcrumb segments like
      // "storage > emulated > 0 > a > b" (clicking a segment browses to that path)
      currentPathEl.innerHTML = '';
      fileListEl.innerHTML = '';

      // Build breadcrumb only when path is not root
      if (path === '/' || !path) {
        currentPathEl.textContent = '/';
      } else {
        // Trim leading slashes then split into parts
        const cleaned = path.replace(/^\/+/, '');
        const parts = cleaned.split('/').filter(Boolean);

        parts.forEach((part, idx) => {
          const span = document.createElement('span');
          span.className = 'path-segment';
          span.textContent = part;
          // Full path this segment represents (leading slash required for browsePath)
          const segPath = '/' + parts.slice(0, idx + 1).join('/');
          span.title = segPath;
          span.tabIndex = 0; // keyboard focusable
          span.addEventListener('click', (e) => {
            e.stopPropagation();
            browsePath(segPath);
            if (fileFilterInput) {
              fileFilterInput.value = '';
              fileFilterInput.focus();
            }
          });
          span.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              span.click();
            }
          });

          currentPathEl.appendChild(span);

          // Add separator except after last
          if (idx < parts.length - 1) {
            const sep = document.createElement('span');
            sep.className = 'path-sep';
            sep.textContent = ' > ';
            currentPathEl.appendChild(sep);
          }
        });
      }

      // Add parent directory navigation
      if (path !== '/' && path !== '/storage/emulated/0') {
        const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
        const li = document.createElement('div');
        li.className = 'file-item';
        li.id = 'parent-dir';
        li.innerHTML = `<span class="icon">..</span> <span class="name">Parent Directory</span>`;
        li.addEventListener('click', () => {
          browsePath(parentPath);
          fileFilterInput.value = ''; // Clear the filter on item click
          fileFilterInput.focus();
        });
        fileListEl.appendChild(li);
      }

      items.sort((a, b) => {
        if (a.type === b.type) return a.name.localeCompare(b.name);
        return a.type === 'folder' ? -1 : 1;
      }).forEach(item => {
        const li = document.createElement('li');
        li.className = 'file-item';
        li.addEventListener('click', () => handleFileClick(item));

        const icon = item.type === 'folder' ? 'codicon codicon-folder' : 'codicon codicon-file';

        const iconClass = item.type === 'folder' ? 'type-folder' : 'type-file';

        let metaText = '';
        if (item.type === 'folder') {
          const fileCount = parseInt(item.files, 10);
          if (fileCount > 0) {
            metaText = `${fileCount} file${fileCount > 1 ? 's' : ''}`;
          }
        } else {
          metaText = formatSize(item.size);
        }
        const dateText = formatDate(item.date);

        li.innerHTML = `
  <span class="icon ${iconClass}">
    <span class="${icon}"></span>
  </span>
  <div class="file-details">
    <span class="name">${item.name}</span>
    <div class="file-meta">
      ${dateText ? `<span>${dateText}</span>` : ''}      
      ${metaText ? `<span>${metaText}</span>` : ''}
    </div>
  </div>
`;

        fileListEl.appendChild(li);
      });
    }

    async function handleFileClick(item) {
      fileFilterInput.value = ''; // Clear the filter on item click
      fileFilterInput.focus();
      if (item.type === 'folder') {
        browsePath(item.path);
      } else { // item.type === 'file'
        if (browseMode === 'save' && fileToSave) {
          const fileName = prompt("Enter file name to save/overwrite:", item.name);

          if (fileName) {

            const path = item.path.substring(0, item.path.lastIndexOf('/') + 1) + fileName;

            console.log("Waiting file path:" + path);
            try {
              // Update active editor data before saving session
              const activeEditorData = getActiveEditorData();
              const fileData = { path, name: fileName };
              if (activeEditorData) {
                activeEditorData.file = fileData;
                activeEditorData.title = fileName;
                activeEditorData.tab.querySelector('span').textContent = fileName;
              }
              // hideBrowseFileModal();
              saveCurrentTab();
              openFileBrowser('open');

            } catch (err) {
              showAlert(`Failed to save: ${err.message}`);
            }
          }
        }
        else {
          // It's a file in 'open' mode, read it and open in a new tab
          try {
            const controller = createAbortController(defaultTimeout);
            const url = `http://${host}:${port}/fileBrowser/api/read`;
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: item.path }),
              signal: controller.signal
            });
            if (response.ok) {
              const fileContent = await response.text();
              addNewTab({
                code: fileContent,
                title: item.name,
                file: { path: item.path, name: item.name }
              });
              // hideBrowseFileModal();
            } else {
              showAlert(`Error reading file: ${await response.text()}`);
            }
          } catch (err) {
            showAlert(`Failed to read file: ${err.message}`);
            console.error('Read file failed:', err);
          }
        }
      }
    }


    function openFileBrowser(mode = 'open', dataToSave = null) {
      expandSidebarWindow();
      hideOtherChildren('sidebar-window', 'browseFileModal');
      // showAlert(sidebarWindow.style.width);
      browseMode = mode;
      fileToSave = dataToSave;
      if (mode === 'save') {
        saveFileFab.style.display = 'block';
      } else {
        saveFileFab.style.display = 'none';
      }
      browsePath(lastFolderPath);
      browseFileModal.style.display = 'flex';
      fileFilterInput.focus();
    }

    // function hideBrowseFileModal() {
    //   browseFileModal.style.display = 'none';
    // }

    async function createFolder() {
      const newName = newFolderNameEl.value.trim();
      if (!newName) {
        showAlert('Please enter a folder name.');
        return;
      }
      const path = `${lastFolderPath}/${newName}`;
      try {
        const controller = createAbortController(defaultTimeout);
        const url = `http://${host}:${port}/fileBrowser/api/mkdir`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path }),
          signal: controller.signal
        });
        if (response.ok) {
          showAlert(`Folder "${newName}" created.`);
          newFolderNameEl.value = '';
          browsePath(lastFolderPath); // Refresh the list
        } else {
          showAlert(`Error creating folder: ${await response.text()}`);
        }
      } catch (err) {
        showAlert(`Failed to create folder: ${err.message}`);
      }
    }

    function formatDate(timestamp) {
      const nouns = 's';
      if (!timestamp) return '';
      const t = parseInt(timestamp, 10);
      if (isNaN(t)) return '';

      const date = new Date(t);
      const now = Date.now();
      const diffMs = now - date.getTime();

      // If timestamp is in the future, fall back to full date string
      if (diffMs < 0) {
        return date.toLocaleDateString(undefined, {
          year: '2-digit',
          month: 'short',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      const diffSec = Math.floor(diffMs / 1000);

      if (diffSec < 60) {
        const unit = Math.max(1, diffSec);
        suffix = unit === 1 ? '' : nouns;
        return `${unit} second${suffix} ago`;
      }

      if (diffSec < 3600) {
        const unit = Math.max(1, Math.floor(diffSec / 60));
        suffix = unit === 1 ? '' : nouns;
        return `${unit} minute${suffix} ago`;
      }

      if (diffSec < 86400) {
        const unit = Math.max(1, Math.floor(diffSec / 3600));
        suffix = unit === 1 ? '' : nouns;
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        return `${unit} hour${suffix} ago at ${hh}.${mm}`;
      }

      // 24 hours or older → use original date format
      return date.toLocaleDateString(undefined, {
        year: '2-digit',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatSize(bytes) {
      bytes = parseInt(bytes, 10);
      if (bytes < 0 || isNaN(bytes)) return '';
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }


    // ------------------------------------- TASKERNET FUNCTIONS ------------------------------------- //

    /**
 * Extract data from XML using a single config object with type casting.
 *
 * @param {string} xmlString - The XML input.
 * @param {Object} config - Extraction configuration.
 * @param {string} config.match - XPath match expression.
 * @param {Array<{key:string, xpath:string, type?:string}>} config.patterns - Extraction rules.
 *   - type can be: "string" (default), "number", "boolean", "integer", or "null"
 * @returns {Array<Object>} Extracted array of objects.
 */
    async function extractFromXml(xmlString, config) {
      const doc = new DOMParser().parseFromString(xmlString, "application/xml");
      const { match, patterns } = config;
      const results = [];

      const matchedNodes = doc.evaluate(
        match,
        doc,
        null,
        XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
        null
      );

      // Helper: convert value based on declared type
      const castValue = (value, type) => {
        if (value == null || value === "") return null;
        switch (type) {
          case "number":
          case "numeric":
            return isNaN(value) ? null : Number(value);
          case "integer":
            return isNaN(value) ? null : parseInt(value, 10);
          case "boolean":
            return ["1", "true", "yes"].includes(value.toLowerCase());
          case "null":
            return null;
          default:
            return value; // string or unspecified
        }
      };

      for (let i = 0; i < matchedNodes.snapshotLength; i++) {
        const node = matchedNodes.snapshotItem(i);
        const item = {};

        for (const { key, xpath, type = "string" } of patterns) {
          const res = doc.evaluate(
            xpath,
            node,
            null,
            XPathResult.STRING_TYPE,
            null
          );

          const rawValue = res ? res.stringValue : null;
          item[key] = castValue(rawValue, type);
        }

        results.push(item);
      }

      return results;
    }
    /*
    Taskernet pattern https://taskernet.com/shares/?user={userId}&id={shareId}

/**
 * Extract Tasker data from a Taskernet share URL.
 * 
 * Example:
 * https://taskernet.com/shares/?user=AS35m8mzep6ZT53%2BqNrzeLiaw4Tx1L4o%2BrgzYDR5Rg4cuz25FIQvQrdsluWlrxmTqBfm&id=Project%3AAccessibility+Action+With+Java
 */
    async function extractTaskernet(codeUrl) {
      // 1️⃣ Parse the URL and extract userId & shareId
      const urlObj = new URL(codeUrl);
      const userId = decodeURIComponent(urlObj.searchParams.get("user"));
      const shareId = decodeURIComponent(urlObj.searchParams.get("id"));

      if (!userId || !shareId) {
        throw new Error("Invalid Taskernet URL — missing user or id parameters.");
      }

      // 2️⃣ Build the API URL
      const apiUrl = `https://taskernet.com/_ah/api/datashare/v1/sharedata/${encodeURIComponent(
        userId
      )}/${encodeURIComponent(shareId)}?a=0&xml=true`;
      console.log("API URL:", apiUrl);

      // 3️⃣ Fetch and parse JSON from Taskernet
      const controller = createAbortController(longTimeout);
      const response = await fetch(apiUrl, {
        method: "GET",
        headers: { "Content-Type": "application/json" },
        signal: controller.signal
      });

      if (!response.ok) {
        throw new Error(`Taskernet request failed: ${response.status}`);
      }

      const jsonData = await response.json();

      // 4️⃣ Extract XML data from response
      const xmlData = jsonData.shareData;
      if (!xmlData) {
        throw new Error("No shareData field found in Taskernet response.");
      }

      // 5️⃣ Define your XPath extraction config
      const config = {
        match: "//Task/Action[code='474']/Str[@sr='arg0']",
        patterns: [
          { key: "task_id", xpath: "../../id", type: "integer" },
          { key: "task_name", xpath: "../../nme", type: "string" },
          { key: "action", xpath: "substring-after(../@sr,'act')", type: "integer" },
          { key: "code", xpath: "string(.)", type: "string" },
          { key: "return", xpath: "string(../Str[@sr='arg1'])", type: "string" },
        ],
      };

      // 6️⃣ Use your extractor to parse data
      const result = extractFromXml(xmlData, config);
      return result;
    }

    // ------------------------------------- DATA & HELPER FUNCTIONS ------------------------------------- //

    function escapeHtmlAttr(str) {
      if (typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function escapeHtml(str) {
      if (typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function unescapeHtml(str) {
      return str
        .replace(/&gt;/g, ">")
        .replace(/&lt;/g, "<")
        .replace(/&#39;/g, "'")
        .replace(/&quot;/g, '"')
        .replace(/&amp;/g, "&");
    }

    function getConfig() {
      let { host, port } = defaultConfig;
      if (runDemo) ({ host, port } = demoConfig);
      return { host, port };
    }


    // ------------------------------------- SHOW ALERT FUNCTIONS ------------------------------------- //

    // Named constants for easy tuning
    const ALERT_SPACING = 10; // px between alerts
    const ALERT_BASE_OFFSET = 20; // initial bottom offset in px
    const ALERT_MOVE_DELAY = 100; // ms before starting fade after moving down
    const ALERT_FADE_DURATION = 150; // ms fade duration (should match CSS)
    const ALERT_MIN_TIMEOUT = 100; // minimal reschedule after hover


    // Ensure alerts container exists
    function ensureAlertsContainer() {
      let c = document.getElementById('alertsContainer');
      if (!c) {
        c = document.createElement('div');
        c.id = 'alertsContainer';
        document.body.appendChild(c);
      }
      return c;
    }

    // showAlert("Long ready", 10000);
    function showAlert(msg, time = 2500, type = "default", functionToRun = null) {
      const d = document.createElement('div');
      // Use class not id — allows multiple alerts
      d.className = 'alert' + (type !== 'default' ? (' ' + type) : '');
      d.id = 'alert';
      d.setAttribute('message', msg);

      // Use textContent so newlines are preserved together with whiteSpace: 'pre-wrap'
      d.textContent = msg;
      // Append into alerts container
      const container = ensureAlertsContainer();
      container.appendChild(d);

      // Push new alert to stack (index-based: lower index => bottom)
      activeAlerts.push(d);

      // Mark expiry and schedule dismissal; store metadata on element
      const now = Date.now();
      d.dataset.expireAt = String(now + time);
      d.dataset.willDismiss = '0';
      d.dataset.paused = '0';

      // Allow interaction: click to dismiss, hover to pause
      // d.style.pointerEvents = 'none';

      // Initialize position so alert appears at bottom before updateAlertPositions applies transform
      // This prevents visual jump when layout recalculates and transforms are applied
      d.style.bottom = ALERT_BASE_OFFSET + 'px';

      // Click to immediately dismiss (nice UX)
      d.addEventListener('click', () => {
        initiateAlertDismiss(d);
        if (functionToRun) functionToRun();
      });

      // Pause dismissal on hover and lock visual position so it doesn't jump
      d.addEventListener('mouseenter', () => {
        if (d.dataset.willDismiss === '1') return; // already dismissing
        // Ensure positions are up-to-date so we can lock the current offset
        updateAlertPositions();

        const expireAt = parseInt(d.dataset.expireAt, 10) || 0;
        const remaining = Math.max(0, expireAt - Date.now());

        // store remaining and clear timeout
        d.dataset.paused = '1';
        d.dataset.pauseRemaining = String(remaining);
        if (d._alertTimeout) {
          clearTimeout(d._alertTimeout);
          delete d._alertTimeout;
        }

        // Lock position: store the current computed offset (set by updateAlertPositions)
        // `currentOffset` is set on each update; fallback to base offset
        const lockOffset = parseInt(d.dataset.currentOffset || String(ALERT_BASE_OFFSET), 10);
        d.dataset.locked = '1';
        d.dataset.lockOffset = String(lockOffset);

        // Temporarily disable transition so it visually doesn't jump while locked
        d.dataset.prevTransition = d.style.transition || '';
        d.style.transition = 'none';
      });

      d.addEventListener('mouseleave', () => {
        if (d.dataset.willDismiss === '1') return; // already dismissing
        if (d.dataset.paused !== '1') return;

        const remaining = parseInt(d.dataset.pauseRemaining, 10) || 0;
        d.dataset.paused = '0';

        // release lock so layout can update
        d.dataset.locked = '0';
        delete d.dataset.lockOffset;

        // restore transition
        d.style.transition = d.dataset.prevTransition || '';
        delete d.dataset.prevTransition;

        // reschedule dismissal with remaining time (or minimal 50ms when 0)
        const schedule = Math.max(ALERT_MIN_TIMEOUT, remaining);
        d.dataset.expireAt = String(Date.now() + schedule);
        d._alertTimeout = setTimeout(() => initiateAlertDismiss(d), schedule);

        // Recalculate positions so it smoothly returns to the stack
        requestAnimationFrame(() => updateAlertPositions());
      });

      // Measure & position on next frame (ensures offsets include wrapping height)
      requestAnimationFrame(() => {
        updateAlertPositions();
        // Use a second frame to allow transitions to activate after layout
        requestAnimationFrame(() => {
          d.style.opacity = '1';
        }, 100);
      });

      // Schedule dismissal
      d._alertTimeout = setTimeout(() => {
        initiateAlertDismiss(d);
      }, time);
    }

    function updateAlertPositions() {
      // Stack alerts from the bottom using their index: lower index => closer to bottom.
      const spacing = ALERT_SPACING; // px between alerts
      let cumulative = ALERT_BASE_OFFSET; // initial bottom offset
      // If the user is hovering an alert but no mousemove/enter fired during a DOM update,
      // query :hover and lock those alerts so they don't jump during this layout cycle.
      const container = ensureAlertsContainer();
      try {
        const hoveredAlerts = Array.from(container.querySelectorAll('.alert')).filter(a => a.matches(':hover'));
        hoveredAlerts.forEach((ha) => {
          if (ha.dataset && ha.dataset.willDismiss === '1') return;
          if (ha.dataset.locked === '1') return; // already locked

          // Determine current offset to lock. Prefer dataset.currentOffset if present.
          let curOff = parseInt(ha.dataset.currentOffset || '', 10);
          if (!curOff || Number.isNaN(curOff)) {
            // Try to read computed transform translateY
            const cs = window.getComputedStyle(ha);
            const tr = cs.transform || cs.webkitTransform || 'none';
            let ty = null;
            if (tr && tr !== 'none') {
              // matrix(a, b, c, d, tx, ty)
              const m = tr.match(/matrix\([^,]+, [^,]+, [^,]+, [^,]+, ([^,]+), ([^)]+)\)/);
              if (m) {
                ty = parseFloat(m[2]);
              } else {
                // fallback: attempt to parse translateY(...) pattern
                const m2 = tr.match(/translateY\((-?\d+)px\)/);
                if (m2) ty = parseFloat(m2[1]);
              }
            }
            if (ty != null && !Number.isNaN(ty)) curOff = Math.round(Math.abs(ty));
            else curOff = ALERT_BASE_OFFSET;
          }

          ha.dataset.locked = '1';
          ha.dataset.lockOffset = String(curOff);
          ha.dataset.prevTransition = ha.style.transition || '';
          ha.style.transition = 'none';

        });
      } catch (e) {
        // ignore any querySelector issues in older browsers
      }

      // Iterate in natural order so index 0 is bottom, index 1 above it, etc.
      activeAlerts.forEach((alert) => {
        // Use offsetHeight (or bounding rect fallback) to get measured height including wrapping
        const height = alert.offsetHeight || alert.getBoundingClientRect().height || 0;

        // If element is locked (hovered), keep its lockOffset instead of recalculating
        if (alert.dataset && alert.dataset.locked === '1' && alert.dataset.lockOffset) {
          const lock = parseInt(alert.dataset.lockOffset, 10) || cumulative;
          alert.style.bottom = lock + 'px';
          // ensure we carry on stacking using the locked element's space
          cumulative = lock + Math.round(height) + spacing;
          // keep currentOffset reflecting locked position
          alert.dataset.currentOffset = String(lock);
          return;
        }

        // Position alert by setting bottom property instead of transform
        alert.style.bottom = cumulative + 'px';

        // Store current offset for potential locking
        alert.dataset.currentOffset = String(cumulative);

        // Increase cumulative by this alert's height + spacing for next alert
        cumulative += Math.round(height) + spacing;
      });
    }

    // Initiate dismissal: mark element, reposition (so it drops to bottom area), then fade+remove
    function initiateAlertDismiss(el) {
      if (!el || el.dataset.willDismiss === '1') return; // already dismissing

      // If there was a pending timeout or a paused state, clear it now
      if (el._alertTimeout) {
        clearTimeout(el._alertTimeout);
        delete el._alertTimeout;
      }
      if (el.dataset.paused === '1') {
        el.dataset.paused = '0';
        delete el.dataset.pauseRemaining;
      }

      // If locked, release lock so it can animate downwards
      if (el.dataset.locked === '1') {
        el.dataset.locked = '0';
        delete el.dataset.lockOffset;
        // restore transition if we disabled it earlier
        el.style.transition = el.dataset.prevTransition || '';
        delete el.dataset.prevTransition;
      }

      // Mark as dismissing (for state only)
      el.dataset.willDismiss = '1';

      // Bring this element visually to the bottom by animating it to the base offset
      // without changing indexes of other alerts (prevents reordering issues).
      el.style.zIndex = '10000';
      // Ensure the element will animate bottom + opacity
      el.style.transition = `bottom ${ALERT_MOVE_DELAY}ms ease, opacity ${ALERT_FADE_DURATION}ms ease`;
      el.style.bottom = ALERT_BASE_OFFSET + 'px';

      // After the move, start fading then remove
      setTimeout(() => {
        el.style.opacity = '0';

        setTimeout(() => {
          const i = activeAlerts.indexOf(el);
          if (i !== -1) activeAlerts.splice(i, 1);
          if (el.parentElement) el.parentElement.removeChild(el);
          updateAlertPositions();
        }, ALERT_FADE_DURATION);
      }, ALERT_MOVE_DELAY);
    }

    // ------------------------------------- MODAL AND OUTPUT FUNCTIONS ------------------------------------- //
    function copyWithFallback(btn, getText) {
      const text = String(getText() ?? '').trim();
      if (!text) {
        const prev = btn.textContent;
        btn.textContent = 'Empty';
        setTimeout(() => btn.textContent = prev, 900);
        return;
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          const prev = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = prev, 1200);
        }).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }

      function fallbackCopy() {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try {
          const success = document.execCommand('copy');
          const prev = btn.textContent;
          btn.textContent = success ? 'Copied!' : 'Failed';
          setTimeout(() => btn.textContent = prev, 1200);
        } catch {
          alert('Copy failed');
        } finally {
          document.body.removeChild(ta);
        }
      }
    }

    function showTasksModal(tasks) {
      expandSidebarWindow();
      hideOtherChildren('sidebar-window', 'tasksModal');
      tasksList.innerHTML = '';
      tasks.forEach(t => {
        const btn = document.createElement('li');
        btn.className = 'task-item';
        btn.textContent = t;
        btn.addEventListener('click', () => {
          const activeEditorData = getActiveEditorData();
          if (activeEditorData) {
            activeEditorData.selectedTask = t;
            status(`Task selected: ${t}`);
          }
        });
        tasksList.appendChild(btn);
      });
      taskFilter.value = '';
      tasksModal.style.display = 'flex';
      taskFilter.focus();
    }

    function status(msg) {
      statusEl.textContent = msg;
    }

    function clearOutputs() {
      console.log('Clearing outputs...');
      varsList.innerHTML = '<li class="notice">No variables yet.</li>';
      retEl.textContent = '';
      errEl.textContent = '';
      const variableCountEl = el('variable-count');
      if (variableCountEl) variableCountEl.style.display = 'none';
      
    }

    function showModal(title, text) {
      modalContent.textContent = text;
      modalTitle.textContent = title;
      modal.style.display = 'flex';
    }

    function hideModal() {
      modal.style.display = 'none';
    }


    // ------------------------------------- JAVA API FUNCTIONS  ------------------------------------- //

    async function fetchTasks() {
      try {
        const url = `http://${host}:${port}/java/api/tasks`;
        const resp = await fetch(url);
        const tasks = await resp.json();
        return Array.isArray(tasks) ? tasks : [];
      } catch (e) {
        console.error('fetchTasks', e);
        return [];
      }
    }

    async function runCode(code, task = null, timeout = null) {
      if (typeof code !== "string") {
        return { error: "runCode(code) requires a code string." };
      }
      if (!timeout) timeout = runTimeout;
      const url = `http://${host}:${port}/java/api/run`;
      const controller = createAbortController(runTimeout, "Run API has been running for " + `${runTimeout / 1000} seconds`);
      const signal = controller.signal;
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      const body = { code };
      if (task) body.task = task;

      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
          signal,
        });

        clearTimeout(timeoutId);

        const text = await resp.text();

        // Always try JSON
        try {
          const json = JSON.parse(text);

          // If HTTP is not ok, attach status code info but still return JSON
          if (!resp.ok) {
            json.httpStatus = resp.status;
          }

          return json;
        } catch (e) {
          // Server responded but JSON invalid → return fallback object
          return {
            error: "Invalid JSON returned from server",
            raw: text,
            httpStatus: resp.status,
          };
        }

      } catch (err) {
        clearTimeout(timeoutId);

        // Timeout
        if (err.name === "AbortError") {
          return {
            error: `Request timed out after ${FETCH_TIMEOUT_MS} ms`,
          };
        }

        // Network or fetch-level error
        return {
          error: err.message || "Network error",
        };
      }
    }

    async function runEditorCode(editorData) {
      if (!editorData || !editorData.editor) {
        status("No editor found.");
        return;
      }

      const editor = editorData.editor;

      try {
        status("Sending…");
        clearOutputs();

        // Get code from the editor
        const code = editor.getValue();

        // Attach task name if present
        let task = null;
        if (editorData.selectedTask) task = editorData.selectedTask;

        // --- CALL THE REFACTORED PURE FUNCTION ---
        console.log("Running code for tab: " + editorData.tabId);
        const result = await runCode(code, task);

        // Save for later use
        editorData.run = result;

        // Show it in the UI
        displayRunResult(editorData);

        status("Done");
        return result;             // <— function now RETURNS the result

      } catch (err) {

        status("Error");

        // Write errors to your error panel
        if (editorData) {
          // errEl.textContent = err.message;
        } else {
          showAlert(err.message);
        }

        throw err;                // <— rethrow so caller can detect the failure
      }
    }


    function displayRunResult(editorData = null) {
      const isEditor = typeof editorData === "object";
      const data = editorData.run;
      const editor = editorData.editor;
      let activeEditorData = getActiveEditorData();
      let activeEditor = activeEditorData ? activeEditorData.editor : null;

      const isActive = editorData.tabId === activeEditorData.tabId;
      console.log("Passed tabId:" + editorData.tabId + " Active tabId:" + activeEditorData.tabId);
      console.log("isActive:", isActive);
      if (!data) {
        // clearOutputs();
        return;
      } else if (!isActive) {
        let type = 'default';
        let text = "Result for tab " + editorData.title + " is received.";
        
        if ('error' in data) {
          type = 'error';
          text = 'Error received for tab ' + editorData.title;
        } 
        
        showAlert(text, 2500, type,setActiveTab.bind(null,editorData.tabId));
        return;
      }

      clearEditorErrors(editor);

      if (Array.isArray(data.variables) && data.variables.length > 0) renderVariables(data.variables);
      else varsList.innerHTML = '<li class="notice">No variables key</li>';


      retEl.textContent = data.return || "";
      const errorText = data.error || "";
      console.log("Error text:", errorText);
      errEl.textContent = errorText;

      if (!isEditor || !data.error) return;

      const regexes = [
        /.*(?<replace>line (?<line>\d+), column (?<column>\d+)).*/gi,
        /.*(?<=at Line: )(?<replace>(?<line>\d+)).*/gi,
      ];

      const errors = [];
      let htmlOutput = escapeHtml(errorText);

      // 🔹 Extract and replace using named groups
      for (const regex of regexes) {
        const matches = Array.from(htmlOutput.matchAll(regex));
        for (const match of matches) {
          const groups = match.groups || {};
          const line = groups.line ? parseInt(groups.line, 10) - 1 : 0;
          const ch = groups.column ? parseInt(groups.column, 10) - 1 : 0;
          const replaceText = groups.replace?.trim() || "";
          const message = match[0].trim();

          errors.push({ line, ch, message });

          const clickable = `<span class="err-link" data-line="${line}" data-ch="${ch}" data-msg="${message}">${replaceText}</span>`;
          htmlOutput = htmlOutput.replace(replaceText, clickable);
        }
      }

      errEl.innerHTML = htmlOutput;

      // 🔹 Add click handler to navigate
      errEl.querySelectorAll(".err-link").forEach((el) => {
        el.addEventListener("click", (ev) => {
          const line = parseInt(ev.currentTarget.dataset.line, 10);
          const ch = parseInt(ev.currentTarget.dataset.ch, 10);
          editor.focus();
          editor.setCursor({ line, ch });
          editor.scrollIntoView({ line, ch }, 100);
        });
      });

      // 🔹 Clear previous error highlights
      const doc = editor.getDoc();
      const lastLine = doc.lineCount();
      for (let i = 0; i < lastLine; i++) {
        editor.removeLineClass(i, "background", "cm-error-line");
        editor.removeLineClass(i, "gutter", "cm-error-gutter");
        editor.setGutterMarker(i, "CodeMirror-lint-markers", null);
      }

      // 🔹 Create global tooltip element (once)
      let tooltip = document.querySelector(".custom-tooltip");
      if (!tooltip) {
        tooltip = document.createElement("div");
        tooltip.className = "custom-tooltip";
        document.body.appendChild(tooltip);
      }

      // 🔹 Apply new highlights + markers
      errors.forEach((err) => {
        editor.addLineClass(err.line, "background", "cm-error-line");
        editor.addLineClass(err.line, "gutter", "cm-error-gutter");

        const marker = document.createElement("div");
        marker.className = "cm-error-dot";
        marker.dataset.tooltip = unescapeHtml(err.message);

        // Custom tooltip behavior
        marker.addEventListener("mouseenter", (ev) => {
          tooltip.textContent = ev.currentTarget.dataset.tooltip;
          tooltip.style.opacity = "1";
          tooltip.style.display = "block";
        });
        marker.addEventListener("mousemove", (ev) => {
          tooltip.style.left = `${ev.pageX + 10}px`;
          tooltip.style.top = `${ev.pageY + 10}px`;
        });
        marker.addEventListener("mouseleave", () => {
          tooltip.style.opacity = "0";
          tooltip.style.display = "none";
        });

        editor.setGutterMarker(err.line, "CodeMirror-lint-markers", marker);
      });

      // 🔹 Focus + scroll to the first error
      if (errors.length > 0) {
        const first = errors[0];
        editor.focus();
        editor.setCursor({ line: first.line, ch: first.ch });
        editor.scrollIntoView({ line: first.line, ch: first.ch }, 100);
      }
    }

    function getImportsFromEditor(editorInstance) {
      if (!editorInstance) return [];
      const code = editorInstance.getValue();
      const lines = code.split("\n");
      const imports = [];
      for (const line of lines) {
        const match = line.trim().match(/^import\s+([a-zA-Z0-9_.\*]+)\s*;?/);
        if (match) imports.push(match[1]);
      }
      return imports;
    }

    function renderVariables(list) {
      varsList.innerHTML = '';
      if (!Array.isArray(list) || !list.length) {
        varsList.innerHTML = '<li class="notice">No variables yet.</li>';
        return;
      }
      list.forEach(v => {
        const li = document.createElement('li');
        li.className = 'var-item';
        const left = document.createElement('div');
        left.className = 'var-left';
        left.innerHTML = `<div class="var-name">${v.name || '(no name)'}</div><div class="preview">${truncate(v.value, 160)}</div>`;
        const right = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'btn-ghost';
        btn.textContent = 'Copy';
        btn.addEventListener('click', () => copyWithFallback(copyBtn, () => String(v.value)));
        let isDragging = false;
        left.addEventListener('mousedown', () => (isDragging = false));
        left.addEventListener('mousemove', () => (isDragging = true));
        left.addEventListener('mouseup', () => {
          if (!isDragging) showModal(v.name || 'value', String(v.value));
        });
        right.appendChild(btn);
        li.appendChild(left);
        li.appendChild(right);
        varsList.appendChild(li);
      });
      updateVariableCount();
    }


    // ------------------------------------- GITHUB FUNCTIONS ------------------------------------- //
    async function getGithubPersonalAccessToken() {
      try {
        const url = `http://${host}:${port}/java/api/githubPersonalAccessToken`;
        const controller = createAbortController(defaultTimeout);
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          },
          signal: controller.signal
        });

        // ⚠️ Handle HTTP errors (e.g. 404, 500)
        if (!response.ok) {
          let bodyText;
          try {
            // Try to read the body text from the server
            bodyText = await response.text();
          } catch {
            bodyText = '(no response body)';
          }

          const errMsg = `Failed to retrieve token: ${bodyText}`;
          throw new Error(errMsg);
        }

        // ✅ Read response as plain text (since server returns token directly)
        const bodyText = (await response.text()).trim();

        if (!bodyText) {
          const msg = 'Empty token response from server';
          showAlert(msg);
          throw new Error(msg);
        }
        showAlert("Personal Access Token is loaded.");
        return bodyText; // token string
      } catch (e) {
        // Network or parsing errors
        showAlert(e.message || String(e));
        return null;
      }
    }

    /**
 * Create or update a GitHub Gist automatically.
 * 
 * @param {string} token - Personal Access Token with gist permissions.
 * @param {string} fileName - The name of the gist file (e.g. "script.js").
 * @param {boolean} isPublic - Whether the gist should be public.
 * @param {string} description - Description for the gist.
 * @param {string} content - File content to upload or update.
 * 
 * @returns {Promise<object>} JSON response from the last GitHub API request.
 */
    async function createOrUpdateGist(token, fileName, isPublic, description, content) {
      const API_VERSION = '2022-11-28';
      const BASE_URL = 'https://api.github.com/gists';

      /**
       * Helper to find an existing gist containing a specific file.
       * Stops early when found.
       */
      async function findExistingGist() {
        let page = 1;
        while (true) {
          const controller = createAbortController(10000);
          const response = await fetch(`${BASE_URL}?per_page=100&page=${page}`, {
            method: 'GET',
            headers: {
              'Accept': 'application/vnd.github+json',
              'Authorization': `Bearer ${token}`,
              'X-GitHub-Api-Version': API_VERSION,
            },
            signal: controller.signal
          });

          if (!response.ok) {
            throw new Error(`Failed to list gists: ${response.status} ${response.statusText}`);
          }

          const gistsPage = await response.json();

          // Look for a matching filename in this page
          const match = gistsPage.find(
            gist => gist.files && Object.keys(gist.files).includes(fileName)
          );

          if (match) return match; // ✅ Found the gist → stop fetching

          // No more gists
          if (gistsPage.length < 100) break;
          page++;
        }

        return null; // ❌ Not found
      }

      // 1️⃣ Check for existing gist first (with early exit)
      const existingGist = await findExistingGist();

      // 2️⃣ If exists → Update gist
      if (existingGist) {
        const updatePayload = {
          description,
          files: {
            [fileName]: { content },
          },
        };
        const controller = createAbortController(10000);
        const updateResponse = await fetch(`${BASE_URL}/${existingGist.id}`, {
          method: 'PATCH',
          headers: {
            'Accept': 'application/vnd.github+json',
            'Authorization': `Bearer ${token}`,
            'X-GitHub-Api-Version': API_VERSION,
          },
          body: JSON.stringify(updatePayload),
          signal: controller.signal
        });

        if (!updateResponse.ok) {
          throw new Error(`Failed to update gist: ${updateResponse.status} ${updateResponse.statusText}`);
        }

        return await updateResponse.json();
      }

      // 3️⃣ If not exists → Create new gist
      const createPayload = {
        description,
        public: isPublic,
        files: {
          [fileName]: { content },
        },
      };
      const controller = createAbortController(10000);
      const createResponse = await fetch(BASE_URL, {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`,
          'X-GitHub-Api-Version': API_VERSION,
        },
        body: JSON.stringify(createPayload),
        signal: controller.signal
      });

      if (!createResponse.ok) {
        throw new Error(`Failed to create gist: ${createResponse.status} ${createResponse.statusText}`);
      }

      return await createResponse.json();
    }

    async function createGistForCurrentTab() {
      const activeEditorData = getActiveEditorData();
      if (!activeEditorData) return;

      const activeEditor = activeEditorData.editor;
      const index = activeEditorData.tabId; // use tabId as the index
      const fileName = prompt("Enter file name:", activeEditorData.title);
      if (!fileName) return;

      const path = `${lastFolderPath}/${fileName}`;

      try {
        console.log(`Creating gist for path: ${path} with ${githubPersonalAccessToken}`);

        const result = await createOrUpdateGist(
          githubPersonalAccessToken,
          fileName,
          false,
          `Code Editor: ${fileName}`,
          activeEditor.getValue()
        );

        const gistUrl = `https://gist.githubusercontent.com/${result.owner.login}/${result.id}/raw/${fileName}`;

        // ✅ Make sure editors[index] exists
        if (!editors[index]) editors[index] = {};

        // ✅ Save gist data for this tab
        editors[index].gist = {
          ...result,
          url: gistUrl,
          fileName,
          createdAt: new Date().toISOString()
        };

        // ✅ Copy URL and notify user
        copyTextToClipboard(gistUrl);
        showAlert(`URL copied to clipboard: ${gistUrl}`);

        console.log(`Gist created successfully: ${gistUrl}`);
      } catch (err) {
        console.error(err);
        showAlert(`Failed to create gist: ${err.message}`);
      }
    }

    async function copyTextToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        console.log('Text copied to clipboard');
      } catch (err) {
        console.error('Failed to copy text: ', err);
      }
    }

    // Example usage:
    // copyTextToClipboard("This text will be copied!");



    function enableTabDragging() {
      const tabList = document.getElementById('tabs-list');

      let draggedItem = null;

      tabList.addEventListener('dragstart', (e) => {
        draggedItem = e.target;
        setTimeout(() => {
          draggedItem.style.opacity = '0.5';
        }, 0);
      });

      tabList.addEventListener('dragend', () => {
        draggedItem.style.opacity = '1';
        draggedItem = null;
      });

      tabList.addEventListener('dragover', (e) => {
        e.preventDefault(); // Allow drop
      });

      tabList.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.target.classList.contains('tab-item') && e.target !== draggedItem) {
          const dropTarget = e.target;
          const parent = dropTarget.parentNode;

          // Determine insert position
          const children = Array.from(parent.children);
          const draggedIndex = children.indexOf(draggedItem);
          const dropIndex = children.indexOf(dropTarget);

          if (draggedIndex < dropIndex) {
            parent.insertBefore(draggedItem, dropTarget.nextSibling);
          } else {
            parent.insertBefore(draggedItem, dropTarget);
          }
        }
      });
    }


    // --- Resizable Elements ---
    // Debounced fireEvent
    const debouncedFireEvent = debounce((name) => {
      if (name) fireEvent(name);
    }, 150);

    // Helpers
    function fireEvent(name) {
      window.dispatchEvent(new Event(name));
    }

    function debounce(fn, delay = 150) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    // Make resizable
    function makeResizable(
      element,
      {
        horizontal = false,
        vertical = false,
        thickness = 6,
        collapseThreshold = null,
        event = null,
        collapseFallback = 0,
        handles = []
      } = {}
    ) {
      element.style.position ||= "relative";

      const edges = [];

      if (handles.includes("left")) edges.push("left");
      if (handles.includes("right")) edges.push("right");
      if (handles.includes("top")) edges.push("top");
      if (handles.includes("bottom")) edges.push("bottom");
      if (horizontal) edges.push("left", "right");
      if (vertical) edges.push("top", "bottom");

      const cursorMap = {
        left: "ew-resize",
        right: "ew-resize",
        top: "ns-resize",
        bottom: "ns-resize"
      };

      const debouncedFireEvent = debounce((name) => {
        if (name) fireEvent(name);
      }, 150);

      // parse a css size into pixels for comparisons (orientation: "horizontal"|"vertical")
      function parseToPx(value, orientation = "horizontal") {
        if (value == null) return null;
        if (typeof value === "number") return value; // treat as px
        const s = String(value).trim();
        if (s === "") return null;

        const num = parseFloat(s);
        if (s.endsWith("px")) return num;
        if (s.endsWith("vw")) return (window.innerWidth * num) / 100;
        if (s.endsWith("vh")) return (window.innerHeight * num) / 100;
        if (s.endsWith("%")) {
          const parent = element.parentElement;
          if (!parent) return (orientation === "horizontal" ? window.innerWidth : window.innerHeight) * (num / 100);
          const size = orientation === "horizontal" ? parent.clientWidth : parent.clientHeight;
          return (size * num) / 100;
        }
        if (s.endsWith("rem")) {
          const rootFs = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
          return num * rootFs;
        }
        if (s.endsWith("em")) {
          const elFs = parseFloat(getComputedStyle(element).fontSize) || 16;
          return num * elFs;
        }
        // fallback: try px parse
        return num;
      }

      // Helper to apply the given fallback value (string with unit or number)
      function applyFallbackSize(edge, fallback) {
        if (fallback == null) fallback = 0;
        if (typeof fallback === "number") {
          applySize(edge, fallback + "px");
        } else {
          // assume string with unit - set as given
          applySize(edge, fallback);
        }
      }

      function applySize(edge, sizeStrOrPx) {
        // sizeStrOrPx could be "70vh" or "200px" or "150"
        if (edge === "left" || edge === "right") {
          // width
          if (typeof sizeStrOrPx === "number") element.style.width = sizeStrOrPx + "px";
          else element.style.width = String(sizeStrOrPx);
        } else {
          // height
          if (typeof sizeStrOrPx === "number") element.style.height = sizeStrOrPx + "px";
          else element.style.height = String(sizeStrOrPx);
        }
      }

      // Keep track of last non-collapsed numeric pixel size (for expansion etc.)
      let lastNonCollapsed = {
        horizontal: parseInt(getComputedStyle(element).width, 10) || element.offsetWidth || 200,
        vertical: parseInt(getComputedStyle(element).height, 10) || element.offsetHeight || 200
      };

      // collapsed states per axis
      let collapsed = { horizontal: false, vertical: false };

      // Ensure handles remain reachable even when element width/height is 0:
      // we'll place handles slightly outside the element using negative offsets.
      const outsideOffset = Math.max(4, Math.floor(thickness / 2));

      edges.forEach((edge) => {
        const bar = document.createElement("div");
        bar.className = "resize-handle-" + edge;
        bar.id = "resize-handle-" + edge;
        bar.style.position = "absolute";
        bar.style.userSelect = "none";
        bar.style.zIndex = "9999";
        bar.style.background = "transparent"; // keep invisible by default
        // position the handle slightly outside so it remains clickable when collapsed
        switch (edge) {
          case "left":
            Object.assign(bar.style, {
              left: -outsideOffset + "px",
              top: 0,
              width: thickness + "px",
              height: "100%",
              cursor: cursorMap[edge]
            });
            break;
          case "right":
            Object.assign(bar.style, {
              right: -outsideOffset + "px",
              top: 0,
              width: thickness + "px",
              height: "100%",
              cursor: cursorMap[edge]
            });
            break;
          case "top":
            Object.assign(bar.style, {
              top: -outsideOffset + "px",
              left: 0,
              height: thickness + "px",
              width: "100%",
              cursor: cursorMap[edge]
            });
            break;
          case "bottom":
            Object.assign(bar.style, {
              bottom: -outsideOffset + "px",
              left: 0,
              height: thickness + "px",
              width: "100%",
              cursor: cursorMap[edge]
            });
            break;
        }

        // Optional: make handle visible on hover (remove/change to suit)
        bar.addEventListener("mouseenter", () => bar.style.background = "rgba(128,128,128,0.06)");
        bar.addEventListener("mouseleave", () => bar.style.background = "transparent");

        element.appendChild(bar);

        let isResizing = false;
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;

        // Pre-parse thresholds to pixels for comparisons
        const collapseThresholdPx = collapseThreshold == null ? null :
          parseToPx(collapseThreshold, (edge === "left" || edge === "right") ? "horizontal" : "vertical");
        const collapseFallbackPx = (collapseFallback == null || collapseFallback === "") ? null :
          (typeof collapseFallback === "number" ? collapseFallback :
            // if fallback is a string unit, we don't convert into px for apply (we'll apply string),
            // but remember parsed px for lastNonCollapsed if possible
            parseToPx(collapseFallback, (edge === "left" || edge === "right") ? "horizontal" : "vertical"));

        bar.addEventListener("mousedown", (e) => {
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          // capture current computed size as starting point (handles 0 correctly)
          startWidth = element.getBoundingClientRect().width || 0;
          startHeight = element.getBoundingClientRect().height || 0;

          // if currently collapsed and there is a remembered last non-collapsed size, use it as start
          if ((edge === "left" || edge === "right") && collapsed.horizontal && lastNonCollapsed.horizontal)
            startWidth = lastNonCollapsed.horizontal;
          if ((edge === "top" || edge === "bottom") && collapsed.vertical && lastNonCollapsed.vertical)
            startHeight = lastNonCollapsed.vertical;

          document.body.style.cursor = cursorMap[edge];
          document.body.style.userSelect = "none";
          e.preventDefault();
        });

        function onMove(e) {
          if (!isResizing) return;

          const rect = element.getBoundingClientRect();
          let newSizePx = 0;

          if (edge === "right") {
            newSizePx = startWidth + (e.clientX - startX);
          } else if (edge === "left") {
            newSizePx = startWidth - (e.clientX - startX);
          } else if (edge === "bottom") {
            newSizePx = startHeight + (e.clientY - startY);
          } else if (edge === "top") {
            newSizePx = startHeight - (e.clientY - startY);
          }

          // clamp minimum to 0
          if (newSizePx < 0) newSizePx = 0;

          // COLLAPSE CHECK (if threshold exists)
          if (collapseThresholdPx != null && newSizePx <= collapseThresholdPx) {
            // set collapsed flag for the axis
            if (edge === "left" || edge === "right") collapsed.horizontal = true;
            else collapsed.vertical = true;

            // apply fallback if given (string or number) else 0
            if (collapseFallback != null && collapseFallback !== "") {
              applyFallbackSize(edge, collapseFallback);
              // if fallback can be parsed to px, store as lastNonCollapsed so expanding works
              if (collapseFallbackPx != null) {
                if (edge === "left" || edge === "right") lastNonCollapsed.horizontal = collapseFallbackPx;
                else lastNonCollapsed.vertical = collapseFallbackPx;
              }
            } else {
              // fallback is absent => collapse to 0px
              applySize(edge, "0px");
            }

            if (event) debouncedFireEvent(event + "-collapsed");
            return;
          }

          // otherwise we are in normal resize: clear collapsed flag and apply numeric px size
          if (edge === "left" || edge === "right") {
            collapsed.horizontal = false;
            lastNonCollapsed.horizontal = newSizePx || lastNonCollapsed.horizontal;
            applySize(edge, Math.round(newSizePx) + "px");
          } else {
            collapsed.vertical = false;
            lastNonCollapsed.vertical = newSizePx || lastNonCollapsed.vertical;
            applySize(edge, Math.round(newSizePx) + "px");
          }

          if (event) debouncedFireEvent(event + "-resized");
        }

        function onUp() {
          if (!isResizing) return;
          isResizing = false;
          document.body.style.cursor = "";
          document.body.style.userSelect = "";
          if (event) debouncedFireEvent(event + "-resize-end");
        }

        // global listeners so dragging stays smooth even if cursor leaves the element
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
      });

      // Return a destroy util to remove handles/listeners if needed
      return {
        destroy() {
          // remove handles and listeners
          edges.forEach((edge) => {
            const handle = element.querySelector(".resize-handle-" + edge);
            if (handle && handle.parentElement === element) handle.remove();
          });
          window.removeEventListener("mousemove", () => { });
          window.removeEventListener("mouseup", () => { });
        }
      };
    }




    // ------------------------------------- SETUP RESIZABLE ELEMENTS ------------------------------------- //


    makeResizable(sidebarWindow, { handles: ["right"], collapseThreshold: "70px" });

    // const editorsContainers = document.querySelector('#editors-container');
    makeResizable(editorsContainer, { handles: ["bottom"], collapseThreshold: "10vh", collapseFallback: "10vh", event: "editors", thickness: 12 });




    // ------------------------------------- ADD EVENT LISTENER ------------------------------------- //

    // Close modal
    closeImportCodeModal.addEventListener('click', () => {
      importCodeModal.style.display = 'none';
    });

    // Close modal
    importCodeModal.addEventListener('click', e => {
      if (e.target === importCodeModal) importCodeModal.style.display = 'none';
    });

    // Fetch code from URL
    document.getElementById('importCode').addEventListener('click', async () => {
      const urlInput = document.getElementById('codeUrl');
      const codeUrl = urlInput.value.trim();

      if (!codeUrl) {
        showAlert('Please enter a valid URL.'); // Changed for general use
        return;
      }

      // Regex to match the specified Taskernet URL pattern
      const taskernetRegex = /^https:\/\/taskernet\.com\/shares\/\?user=.+&id=.+/;

      try {
        if (taskernetRegex.test(codeUrl)) {
          // --- CONDITION 1: Taskernet URL ---
          // This is the sequence you provided for matching URLs
          const tasks = await extractTaskernet(codeUrl);
          if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
              const action_number = task.action + 1;
              const title = task.task_name
                ? `${task.task_name} [@${action_number}].bsh`
                : `[@${task.task_id + 1}].bsh`;
              addNewTab({ code: task.code, title });
            });
            showAlert('Taskernet data loaded successfully.');
          } else {
            showAlert('No java codes found in the provided Taskernet URL.');
          }
        } else {
          // --- CONDITION 2: Other URL ---
          // Fetch against the URL
          const controller = createAbortController(defaultTimeout);
          const response = await fetch(codeUrl, { signal: controller.signal });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          // The code is the response text
          const code = await response.text();

          // Get title from the url path after the last /
          const path = new URL(codeUrl).pathname;
          const title = path.split('/').pop() || 'imported_script.bsh'; // Default title if path ends in /

          // Run the function
          addNewTab({ code: code, title: title });
          showAlert('Code loaded successfully from URL.');
        }
      } catch (error) {
        // General error message
        showAlert(`Failed to fetch data: ${error.message}`);
      } finally {
        importCodeModal.style.display = 'none';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      enableTabDragging();
    });



    // --- Event Listeners ---
    saveFileFab.addEventListener('click', async () => {
      if (browseMode === 'save' && fileToSave) {
        const activeEditorData = getActiveEditorData();
        const fileName = prompt("Enter file name:", activeEditorData.title);
        if (fileName) {
          const path = `${lastFolderPath}/${fileName}`;
          try {
            const activeEditorData = getActiveEditorData();
            if (activeEditorData) {
              activeEditorData.file = { path, name: fileName };
              activeEditorData.title = fileName;
              activeEditorData.tab.querySelector('span').textContent = fileName;
            }

            // hideBrowseFileModal();
            saveCurrentTab();
          } catch (err) {
            showAlert(`Failed to save file: ${err.message}`);
          }


        }
      }
    });


    addTabBtn.addEventListener('click', () => addNewTab());
    // closeBrowseFileModal.addEventListener('click', hideBrowseFileModal);
    browseFileModal.addEventListener('click', e => {
      if (e.target === browseFileModal) hideBrowseFileModal();
    });
    mkdirBtn.addEventListener('click', createFolder);
    fileFilterInput.addEventListener('input', () => {
      const filterText = fileFilterInput.value.toLowerCase();
      const items = fileListEl.getElementsByTagName('li');
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const itemName = item.querySelector('.name').textContent
        // Match the filter text with the file/folder name
        if (itemName.toLowerCase().includes(filterText)) {
          item.style.display = 'flex'; // Show item
        } else {
          item.style.display = 'none'; // Hide item
        }
      }
    });

    fileFilterInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                // Get the first visible <li> file item (skips parent-dir which is a <div>)
                const firstItem = fileListEl.querySelector('li:not([style*="display: none"])');
                if (firstItem) {
                    firstItem.click();
                }
                fileFilterInput.focus();
            } else if (event.key === 'Backspace' && fileFilterInput.value === '') {
                const parentDir = fileListEl.querySelector('#parent-dir');
                if (parentDir) {
                    parentDir.click();
                }
            }
        });
    // loadSessionBtn.addEventListener('click', loadLastSession);
    runBtn.addEventListener('click', {
      handleEvent() {
        const activeEditorData = getActiveEditorData();
        if (activeEditorData) {
          runEditorCode(activeEditorData);
        }
      }
    });


    copyReturnBtn.addEventListener('click', () => copyWithFallback(copyReturnBtn, () => retEl.textContent));

    copyErrorBtn.addEventListener('click', () => copyWithFallback(copyErrorBtn, () => errEl.textContent));

    copyBtn.addEventListener('click', () => copyWithFallback(copyBtn, () => modalContent.textContent));

    closeModal.addEventListener('click', hideModal);

    modal.addEventListener('click', e => {
      if (e.target === modal) hideModal();
    });

    taskFilter.addEventListener('input', () => {
      const filter = taskFilter.value.toLowerCase();
      Array.from(tasksList.children).forEach(btn => {
        btn.style.display = btn.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
      });
    });

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const activeEditorData = getActiveEditorData();
        runEditorCode(activeEditorData);
        // runCode();
      }
    }
    );

    // --- Output Panel Logic ---
    document.addEventListener("DOMContentLoaded", () => {

      const sections = document.querySelectorAll(".mb-8");

      // Button → container ID
      const containerMap = {
        "error-btn": "error-container",
        "return-btn": "return-container",
        "variable-btn": "vars-container"
      };

      const errorBtn = el("error-btn"),
        returnBtn = el("return-btn"),
        varBtn = el("variable-btn");

      const errPre = el("err"),
        retPre = el("ret"),
        varsList = el("vars");

      // Activate by CONTAINER ID (NOT index)
      function activateById(containerId, highlight = "active") {

        // Toggle active section
        sections.forEach(s =>
          s.classList.toggle("active", s.id === containerId)
        );

        // Reset button states
        document.querySelectorAll(".btn-ghost")
          .forEach(b => b.classList.remove("active", "error-active"));

        // Find the button that corresponds to the container
        const btnId = Object.keys(containerMap)
          .find(key => containerMap[key] === containerId);

        if (btnId) el(btnId).classList.add(highlight);
      }

      // Update view based on available data
      function updateView() {
        const hasError = errPre.textContent.trim().length > 0;
        const hasReturn = retPre.textContent.trim().length > 0;
        const hasVars = varsList.querySelectorAll("li:not(.notice)").length > 0;

        // Reset buttons
        document.querySelectorAll(".btn-ghost")
          .forEach(b => b.classList.remove("active", "error-active"));

        if (hasError) {
          errorBtn.classList.add("error-active");
          activateById("error-container", "error-active");
          return;
        }

        if (hasReturn) {
          activateById("return-container", "active");
          return;
        }

        if (hasVars) {
          activateById("vars-container", "active");
          return;
        }

        // If nothing exists, hide all sections
        sections.forEach(s => s.classList.remove("active"));
      }

      // Mutation observers to react to content changes
      const observer = new MutationObserver(updateView);

      observer.observe(errPre, { childList: true, characterData: true, subtree: true });
      observer.observe(retPre, { childList: true, characterData: true, subtree: true });
      observer.observe(varsList, { childList: true, subtree: true });

      // Button click handlers
      for (const [btnId, containerId] of Object.entries(containerMap)) {
        el(btnId).addEventListener("click", () => {

          const hasError = errPre.textContent.trim().length > 0;

          // Reset buttons
          document.querySelectorAll(".btn-ghost")
            .forEach(b => b.classList.remove("active", "error-active"));

          // Activate the chosen section
          sections.forEach(s =>
            s.classList.toggle("active", s.id === containerId)
          );

          // Highlight clicked button
          el(btnId).classList.add("active");

          // Keep error highlighted even if switched away
          if (hasError) errorBtn.classList.add("error-active");
        });
      }

      // Initial view sync
      updateView();
    });

    // --- Initial Load ---
    loadLastSession();
    openFileBrowser('open');

    // ------------------------------------- ALERT ------------------------------------- //

    if (runDemo) showAlert("Running demo: " + demoConfig.host + ":" + demoConfig.port, 3000);



  </script>


<div id="alertsContainer"></div><div class="custom-tooltip"></div></body></html>